## 0. はじめに

ここで紹介するClaudeを使った開発手法は、実際に私が実施したものです。
そして、最新の開発手法はもう少し進んでいます。
なるべく人間の介在を少なくして、エージェントにタスクを移譲、複数エージェントの並行動作などをするのがトレンドです。

おそらく、実際の業務での開発には、そのような大規模ソースコード向けの手法が必要になってきます。
ただし、それもベースはここで紹介する中規模開発のものと同じです。

エージェントに丸投げしていく環境を構築する前に、このように人間がある程度がっつり介在する
中小規模開発を経験することが重要なのではないかと考えています。

ということで、まずは、中小規模のＡＩ開発で基本となるところを紹介していきます。

## 1. 最重要は「ゴールの共有」

Claude Codeを使ってアプリケーションを作成するときに、もっとも重要なことは
ゴールイメージを Claude と共有することです。

具体的に言うと、以下を共有します。

* 「このアプリで、何を実現したいのか？」
* 「このアプリを使ったら何が楽になるのか？」
* 「自分が求めているコダワリのポイントはどこにあるのか？」

このあたりは、一旦、ばーーーーっとMarkdown形式の箇条書きで書き出してしまいます。
整合性を気にするは必要ありません。
あとで、Claudeくんが、指摘してくれます。

## 2. ブレークダウンは、壁打ちが全て！

2.1 プロンプトを作成する
2.2 Claudeとの壁打ちで要件定義書を作成する
2.3 Project機能を使って、アクションプランを作成する
2.4 Claude Codeへの情報引継ぎをClaudeに作ってもらう

## 2.1 プロンプトを作成する

Claudeと共有する項目一覧を作成したら、以下のような感じで、プロンプトを作成します。

```
## 
相談に乗ってください。
markdown形式の知識を蓄積して、それを検索、要約、知識ベースとして活かしてQ&Aなど活用するためのシステムを作成したいです。
まだ、要件というか、こういう物が欲しいなぁという要望がバラバラであってまとまっていない感じです。
１つのシステムの要件として定義するための手伝いをして頂けませんか？
* markdownエディタがある
* LLMを使った要約機能がある
* 要約もmarkdownで保存する
* ファイルが添付できる
* markdownにmermaid記法を埋め込める
* markdownにoembedでリンク先のコンテンツを埋め込める
* markdownに画像を埋め込める(添付した画像を埋め込む)
* markdownとか、添付はどこかのフォルダに格納する
* 言語はpython
* Webブラウザからアクセスする
* LDAP連携が欲しい
* ログイン機能は必須
* グループとロールは必要
* グループやロール、個別のユーザ単位でアクセス権限を付与できる
* アクセスは、見えない, Read Only, Read/Write, 削除可能 の3種類
* 保存するときは、差分を保存する（git的なリポジトリ管理か？)
* 削除も同様に削除前のものを保存しておく
* メインはファイルで保存するが、キャッシュと検索用のINDEXとして、OpenSearchを利用する
* OpenSearchで、BM25検索と、ベクトル埋め込みでベクトル検索の複合検索をする
* 蓄えた情報をもとに、RAGでLLMに質問して回答してもらう
* REST APIで記事を読み書きできるようにする
* MCPで記事を読み書きできるようにする
* タグ付けできるようにする
* タグは複数可能
* タグをつけない場合は、LLMによるタグ付け支援
* 複数の記事を１つの記事にまとめる機能(タブ管理？)
* Wikiのような、左にメニューがあってそこから右のビューで記事にアクセスできる機能
* Markdownの小さい単位を１つのチャンク的な感じで管理して、複数のチャンクを渡すとLLMがいい感じの記事にしてくれる機能
```

## 2.2 Claudeとの壁打ちで要件定義書を作成する

あとは、このプロンプトを Claude (not Claude Code)に入力して、
Cluadeくんからの質問に回答したり、こういうこともしたいなー、など追加で思いついたことを
付け加えたりして、要件定義書を作ってもらいます。

要件定義書も上記と同様に、Claudeくんとやり取りして、気に入らないところを修正していってください。

以下のようなやりとりになります。

## Claude (1)

```
もちろんです！とても興味深いプロジェクトですね。Markdownベースの知識管理システムで、LLMを活用したRAGやタグ付け支援まで含む、かなり本格的な構想です。

要件を整理するにあたって、まずいくつかの観点で現状の要望を分類し、不明点や検討が必要な点を洗い出していきましょう。

## 現状の要望を整理すると

大きく以下のカテゴリに分けられそうです：

**コンテンツ管理**: Markdownエディタ、ファイル添付、画像・mermaid・oembed埋め込み、タグ付け、差分管理（Git的）

**検索・AI機能**: OpenSearchでのハイブリッド検索、LLMによる要約・タグ付け支援・記事生成、RAG Q&A

**アクセス制御**: LDAP連携、ログイン、グループ/ロール、4段階の権限（不可視/RO/RW/削除可）

**外部連携**: REST API、MCP対応

**UI/UX**: Wiki風のナビゲーション、複数記事のタブ管理、チャンクから記事生成

---

## 整理のために確認したい点

いくつか質問させてください。方向性が明確になると、より具体的な要件定義に落とし込めます。

1. **利用規模・ユーザー数**: 個人〜数名のチーム向け？それとも部門・組織規模（数十〜数百人）？

2. **デプロイ環境**: オンプレミス前提？クラウド（AWS/GCP等）も選択肢？Docker/Kubernetes？

3. **LLMの選定**: 特定のLLMを想定していますか？（OpenAI API、Claude API、ローカルLLM、Azure OpenAI等）

4. **「チャンク」の粒度**: 見出し単位（##）？段落単位？それとも手動で区切る？

5. **優先度**: MVP（最小限の動くもの）として最初に欲しい機能はどのあたりですか？

6. **既存システムとの関係**: 既存のWikiやドキュメント管理システムからの移行を想定？

これらが明確になると、フェーズ分けや技術選定も含めた要件定義書の形にまとめやすくなります。どこから話を進めましょうか？
```

## Nara (2)

```
> 利用規模・ユーザー数: 個人〜数名のチーム向け？それとも部門・組織規模（数十〜数百人）？
数人から数十人のレベルで考えています。100人は行かない想定です。
> デプロイ環境: オンプレミス前提？クラウド（AWS/GCP等）も選択肢？Docker/Kubernetes？
オンプレミスのみです。
たしかに、Dockerはあると嬉しいかもしれませんね。
> LLMの選定: 特定のLLMを想定していますか？（OpenAI API、Claude API、ローカルLLM、Azure OpenAI等）
基本はローカルLLMです。
オプションで、Claude API/Open AI/Google/Azure/Amazon Bedrock なども対応できると嬉しいです。
> 「チャンク」の粒度: 見出し単位（##）？段落単位？それとも手動で区切る？
手動で区切る想定です。
自分でドキュメントを作る時点で細切れのメモを作って、それを統合していくイメージです。
> 優先度: MVP（最小限の動くもの）として最初に欲しい機能はどのあたりですか？
エディタ・ビューアは必須ですね。
あとは、アカウント管理も後から追加するのはキツイと思うので最初からある方が良いです。
マークダウンを埋め込んだ、Wiki的な管理システムは欲しいですね。（ちょっと、記法など考えないといけませんが）
> 既存システムとの関係: 既存のWikiやドキュメント管理システムからの移行を想定？
一応、移行元は、Knowledgeというシステムが想定です。https://information-knowledge.support-project.org/ja/
あとは、Twitter(X)からのインポートも想定しています。
```

## Claude (2)

```
ありがとうございます！かなり具体的になってきました。

整理すると、**オンプレミス向けのMarkdownベース知識管理システム**で、ローカルLLMを基本としつつクラウドAPIもオプション対応、というコンセプトですね。

## 追加で確認させてください

**ローカルLLMについて**
- Ollama、vLLM、llama.cpp など、何か想定はありますか？
- 埋め込みモデルも同様にローカル想定？（sentence-transformers等）

**Wiki的な管理の記法**
- 例えば `[[ページ名]]` でリンク、`{{include:ページ名}}` で埋め込み、のようなイメージ？
- 階層構造は必要？（フォルダ的な/タグのみでフラット？）

**Git的な差分管理**
- 実際にGitリポジトリを使う？それともGit風の差分管理を自前実装？
- Gitを使う場合、gitea/gogs等との連携も視野に入れる？

**Knowledge/Twitterからの移行**
- Knowledgeのデータ形式は把握されてますか？（DB直接？エクスポート機能？）
- Twitterは自分のツイートのみ？ブックマークも？

---

これらが決まれば、要件定義書のドラフトを作成できます。

また、**プロジェクト名**は何か考えていますか？仮称でも構いません。要件定義書を作る際にあると便利です。
```

## Nara (3)

```
> ローカルLLMについて
> 
> Ollama、vLLM、llama.cpp など、何か想定はありますか？
> 埋め込みモデルも同様にローカル想定？（sentence-transformers等）
基本は、ollamaを使って、gpt-oss-120bの想定です。
ただ、llama.cppを使って、Devstral-2-123bも一応想定しておきたいです。
> Wiki的な管理の記法
> 例えば [[ページ名]] でリンク、{{include:ページ名}} で埋め込み、のようなイメージ？
どうしましょうね。
いまは、左のメニュー部分の構造だけ書いて、そのメニューに対応する markdown記事を表示するイメージです。
> 階層構造は必要？（フォルダ的な/タグのみでフラット？）
階層構造は、疑似的なものでＯＫです。
> Git的な差分管理
> 実際にGitリポジトリを使う？それともGit風の差分管理を自前実装？
> Gitを使う場合、gitea/gogs等との連携も視野に入れる？
オンプレなのでGitHubは使えませんし、gitlabとか使った方が良いですかね？
基本、差分管理は実装が楽な方で良いと思っています。
> Knowledge/Twitterからの移行
> Knowledgeのデータ形式は把握されてますか？（DB直接？エクスポート機能？）
knowledgeはエクスポート機能が無いので、ＤＢからエクスポートするツールを作る必要がありますね。
ただ、ツールは後回しで良いと思っています。
> Twitterは自分のツイートのみ？ブックマークも？
twitterのインポートは、twilogというサイトで過去のツイートをbookmarkを含めてcsvでエクスポートできるので、それを使います。
> これらが決まれば、要件定義書のドラフトを作成できます。
> また、プロジェクト名は何か考えていますか？仮称でも構いません。要件定義書を作る際にあると便利です。
Markdown Stack とかいかがでしょう
```

## Claude (3)

```
「Markdown Stack」いい名前ですね！シンプルで分かりやすいです。

情報がかなり揃ってきたので、要件定義書のドラフトを作成しましょう。

いくつか最後の確認をさせてください：

**埋め込みモデル（ベクトル検索用）**
- Ollamaで対応できるモデル（nomic-embed-text等）を想定？
- それとも別途 sentence-transformers 等を使う？

**差分管理の方針**
- 「楽な方」でいくと、**gitpython でベアリポジトリを内部管理**する方式が良さそうです
- 外部のGitLab/Gitea連携は不要で、内部で完結させる形
- これなら差分表示・ロールバック・削除履歴も比較的シンプルに実装できます

**認証について**
- LDAP連携 + ローカルアカウント両対応？
- それともLDAP専用？（管理者アカウントだけローカル？）

---

上記が決まれば、要件定義書のドラフトをMarkdownファイルで作成します。

また、作成後に一緒に検討したい点として：
- フェーズ分け（MVP → 段階的拡張）
- 技術スタック選定（FastAPI? Flask? フロントエンドは?）
- 画面構成のワイヤーフレーム案

なども進められますが、まずは要件定義書を固めることを優先しましょうか？
```

## Nara (4)

```
> 埋め込みモデル（ベクトル検索用）
> 
> Ollamaで対応できるモデル（nomic-embed-text等）を想定？
> それとも別途 sentence-transformers 等を使う？
nomic-embed-textを想定しています。
> 差分管理の方針
> 「楽な方」でいくと、gitpython でベアリポジトリを内部管理する方式が良さそうです
> 外部のGitLab/Gitea連携は不要で、内部で完結させる形
> これなら差分表示・ロールバック・削除履歴も比較的シンプルに実装できます
なるほど。gitpythonが良さそうですね。gitpythonでいきましょう。
> 認証について
> 
> LDAP連携 + ローカルアカウント両対応？
> それともLDAP専用？（管理者アカウントだけローカル？）
LDAP連携 + ローカルアカウント両対応 でお願いします。
LDAPが無い環境でも使いたいのですが、LDAPが必須の環境もあり、どちらの対応も必要な状況です。
```

## Claude (4)

```
了解しました！必要な情報が揃いましたので、要件定義書のドラフトを作成します。要件定義書のドラフトを作成しました。

主なポイントをまとめると：

**構成**
- 機能要件を7カテゴリに整理（コンテンツ管理、エディタ、Wiki、検索、AI、認証、外部連携）
- 非機能要件（性能、セキュリティ、運用）
- 技術スタック案
- 5フェーズの開発計画

**MVP（Phase 1）の範囲**
- 認証（ローカルアカウント）
- Markdownエディタ・ビューア
- 記事CRUD + 添付ファイル
- Git差分管理
- Wiki風UI
- タグ管理（手動）
- 基本検索

**確認・検討いただきたい点**

1. **フロントエンド**: React と Vue.js どちらが良いですか？

2. **メタデータDB**: SQLite（シンプル）か PostgreSQL（スケーラビリティ）か

3. **Wiki記法**: `[[記事タイトル]]` 形式でリンク、`{{include:記事ID}}` で埋め込み、という案で良いですか？

4. **フェーズ分け**: MVP の範囲は妥当ですか？追加・削除したい機能はありますか？

5. **その他**: 漏れている要件や、修正したい箇所はありますか？

フィードバックをいただければ、要件定義書を更新していきます！
```

ここで、要件定義書の初版ができたので、一旦この要件定義書をダウンロードして、
別のセッションでレビューを依頼します。
レビューを出して来たら、「レビューレポートをマークダウン形式で作成してください」と依頼して
作成して貰い、ダウンロード。

ダウンロードしたレビューレポートを、元の要件定義のセッションのチャットに添付して、
「レビューチームにレビューをしていただきました。レポートが上がってきましたので、取り入れるべき意見があるかどうか、精査をお願いします。」
と依頼します。

・要件定義の時と同様に、気になるところ、わからないところを質問
・気に入らないところを修正依頼
・Claudeからの質問に回答

というのを繰り返して、特に不満が無くなったら、そこで完成です。

## 2.3 Project機能を使って、アクションプランを作成する

要件定義書ができたら、プロジェクトを作成します。
プロジェクトのファイルとして、要件定義書を登録して、以下のプロンプトでアクションプランを作成してもらいます。

```
Markdown Stackの要求要件をプロジェクトに登録しました
ドキュメントを参照して、今後のアクションプランを作成してください。
```

こちらも今までと同様に、Claudeくんとやり取りしていきます。
「レビューに出すので、作成頂いたアクションプランをマークダウンでダウンロードできるようにしてください」
と依頼し、ダウンロードして、別のセッションでレビューを依頼します。

レビューを出して来たら、「レビューレポートをマークダウン形式で作成してください」と依頼して作成して貰い、ダウンロード。

ダウンロードしたレビューレポートを、元のアクションプラン作成のセッションのチャットに添付して、
「レビューチームにレビュー依頼をしました。レポートを頂きましたので、確認をお願いします。」
のような感じで、依頼します。

・要件定義の時と同様に、気になるところ、わからないところを質問
・気に入らないところを修正依頼
・Claudeからの質問に回答

をしていきます。そして、こちらも特に不満が無くなったら、そこで完成です。


2.4 Claude Codeへの情報引継ぎをClaudeに作ってもらう

そして、アクションプランが完了したら、最後にClaude Codeへの移行です。

```
ありがとうございます。このプランを元にClaude Code で開発をしようと思います。
その時に必要な、Claude.mdや、Agent.md、Skill.mdなどの開発を制御するためのドキュメントをどのように作成するべきでしょうか？
```

これで、Claude Code側に設定するべきファイル群を作成してくれます。

この後は、以下のようなやりとりをしています。
（最後はClaude Codeの設定で秘密鍵の生成方法を調べるのが面倒だったので、調べてもらっています）

```
markdown-stack-development-plan-v2.md と markdown-stack-requirements-v0_7_0.md はそれぞれ、どこに配置しておくべきでしょうか？　それとも、配置しないほうが良いですか？
```

```
ありがとうございます。docの下に配置しました。
これより、Claude Codeで開発を始めます。ここで会話した内容で、Claude Code側に引き継いだほうが良いことがあれば、教えてください。（先ほど頂いたclaude-code-config-templates.zipについてはすべて配置済みです）
```

```
ありがとうございます。ここまで完了しましたが、ssh接続のところで躓いています。
ssh接続はパスワードでつないでいたのですが、パスワードではなく秘密鍵が必要なようです。
どのように作成して、どのようにファイルを配置すればよいか教えてください。
```

## 3. レビューとテストは過剰にやらせる

あとは、Claudeで教えてもらったまま、Claude Code を開始します。
気になったところがあれば、その都度、依頼をかけていきます。
今回途中で割り込んだポイントは３つ

* いったんフェーズが終わるたびに作成物のレビューと、ドキュメントの整合性確保
* フェーズが終わったら、セッションを閉じて別セッションに移るため、引き継ぎ資料と引き継ぎプロンプトを作成依頼
* 一応、動作するものができたときは、一旦、サーバーを起動して貰って、自分で触ってみる（変なとこがあれば修正してもらう）

今回の開発は、それなりに動くところで、これで持っていくことができました。

