# Markdown Stack 開発計画書

**バージョン**: 2.0.0  
**作成日**: 2026-02-23  
**基準要件**: 要件定義書 v0.7.0  

---

## 1. 計画概要

### 1.1 開発方針

- **Phase 1（MVP）を最優先**で開発し、早期に動作するシステムを構築する
- Phase 1は最小依存構成（Python + FastAPI + SQLAlchemy + gitpython）で完結させる
- フロントエンド・バックエンドは並行開発し、OpenAPIスキーマで結合する

### 1.2 品質ゲート方針

すべてのステップは以下のゲート構造に従って進行する。ゲートを通過しなければ次の工程に進まない。

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Step内のゲート構造                           │
│                                                                     │
│  [仕様作成] ──▶ 【G1: 仕様レビュー】                                │
│       ↓          合格 ↓                                             │
│  [実装]    ──▶ 【G2: ソースレビュー】──▶ 【G3: 単体テスト】          │
│       ↓                                    合格 ↓                   │
│  [機能完成] ──▶ 【G4: I/Fレビュー】 ──▶ 【G5: 機能間結合テスト】    │
│                                            合格 ↓                   │
│                                       次ステップへ                   │
└─────────────────────────────────────────────────────────────────────┘
```

| ゲート | 名称 | タイミング | 内容 |
|--------|------|------------|------|
| **G1** | **仕様レビュー** | 仕様書作成後 | 要件定義との整合性、設計の妥当性、I/F一貫性を確認 |
| **G2** | **ソースレビュー** | 実装完了後 | コード品質、設計準拠、セキュリティ観点の確認 |
| **G3** | **単体テスト** | ソースレビュー通過後 | 個別モジュール/関数の正常系・異常系テスト実行・全件合格 |
| **G4** | **I/Fレビュー** | 機能完成時 | 公開I/F（API・コンポーネントProps・ストア）の整合性確認 |
| **G5** | **機能間結合テスト** | I/Fレビュー通過後 | 機能間の連携を実データで検証、全件合格 |

**ゲート不合格時のルール**:
- 不合格事項を Issue に記録し、修正後に再レビュー/再テストを実施
- 重大な設計変更が必要な場合は、前のステップまで差し戻し

### 1.3 Phase全体ロードマップ

| Phase | 名称 | 期間目安 | 主要成果物 |
|-------|------|----------|------------|
| **Phase 1** | **MVP** | **14週間** | 基本的な知識管理システム |
| Phase 2 | 検索強化 | 7週間 | OpenSearch統合、ハイブリッド検索 |
| Phase 3 | AI機能 | 7週間 | LLM要約・タグ提案・RAG Q&A |
| Phase 4 | エンタープライズ | 9週間 | LDAP・監査ログ・REST API・MCP |
| Phase 5 | 拡張機能 | 継続的 | Mermaid・oEmbed・インポート等 |

> **注**: 旧版（v1.0.0）よりPhase 1を+2週としている。レビュー・テストゲートの工数を反映した。

### 1.4 前提条件

- 開発者: 1〜2名（フルスタック想定）
- 開発環境: Docker対応のローカル環境
- CI/CD: GitHub Actions等を想定（後続タスクで構築）

---

## 2. Phase 1: MVP — 詳細開発計画

### 2.1 ステップ一覧

| # | ステップ | 期間 | 依存関係 |
|---|----------|------|----------|
| 1 | プロジェクト基盤構築 | 2週 | なし |
| 2 | バックエンド: データモデル・Git連携 | 2.5週 | Step 1 |
| 3 | バックエンド: 認証・認可 | 2週 | Step 2 |
| 4 | バックエンド: API実装 | 2.5週 | Step 3 |
| 5 | フロントエンド: 基盤・レイアウト | 1.5週 | Step 1（並行可） |
| 6 | フロントエンド: 機能実装 | 2.5週 | Step 4, 5 |
| 7 | システムテスト・E2E | 1週 | Step 6 |

---

### Step 1: プロジェクト基盤構築（2週）

#### 1-1. 仕様書作成

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-01 | **API仕様書（OpenAPI 3.1）** | 全エンドポイント定義（UI API + 管理API） |
| D-02 | **DBスキーマ設計書** | SQLAlchemy モデル定義、ER図 |
| D-03 | **Git リポジトリ構造設計** | ディレクトリ規約、コミットメッセージ規約 |
| D-04 | **コンポーネント設計書** | フロントエンド主要画面・コンポーネント一覧 |

**API仕様で定義するエンドポイント（Phase 1スコープ）**:

```
# 認証（Cookieセッション）
POST   /api/ui/auth/login
POST   /api/ui/auth/logout
GET    /api/ui/auth/me

# 記事 CRUD
GET    /api/ui/articles                    # 一覧（検索含む）
POST   /api/ui/articles                    # 作成
GET    /api/ui/articles/{id}               # 取得（ETag付き）
PUT    /api/ui/articles/{id}               # 更新（If-Match必須）
DELETE /api/ui/articles/{id}               # 論理削除

# 記事バージョン管理
GET    /api/ui/articles/{id}/history       # コミット履歴
GET    /api/ui/articles/{id}/diff/{commit} # 差分表示
POST   /api/ui/articles/{id}/rollback     # ロールバック

# 添付ファイル
POST   /api/ui/articles/{id}/attachments   # アップロード
GET    /api/ui/attachments/{hash}          # ダウンロード

# タグ
GET    /api/ui/tags                        # タグ一覧
GET    /api/ui/tags/{tag}/articles         # タグ別記事一覧

# Wiki
GET    /api/ui/wikis                       # Wiki一覧
GET    /api/ui/wikis/{id}/structure        # メニュー構造取得
PUT    /api/ui/wikis/{id}/structure        # メニュー構造更新

# 検索（Phase 1: DB LIKE検索）
GET    /api/ui/search?q=...&tag=...

# 管理（adminロール専用）
GET    /api/ui/admin/articles?include_hidden=true
GET    /api/ui/admin/articles?include_frozen=true
POST   /api/ui/admin/articles/{id}/freeze
POST   /api/ui/admin/articles/{id}/unfreeze
POST   /api/ui/admin/articles/{id}/restore     # 削除復元

# ユーザー管理
GET    /api/ui/admin/users
POST   /api/ui/admin/users
PUT    /api/ui/admin/users/{id}
DELETE /api/ui/admin/users/{id}
```

#### ✅ G1: 仕様レビュー（Step 1）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 1-G1-01 | 要件カバレッジ | 要件定義 v0.7.0 Phase 1 スコープ全項目がAPI/DB/画面設計に反映されているか |
| 1-G1-02 | I/F一貫性 | APIエンドポイント名・パラメータ・レスポンス形式の命名規約統一 |
| 1-G1-03 | DBスキーマ整合性 | ER図とSQLAlchemyモデル定義の一致、外部キー制約の妥当性 |
| 1-G1-04 | Git構造妥当性 | ディレクトリ構造が要件定義 2.1.2 に準拠しているか |
| 1-G1-05 | 画面網羅性 | 要件定義の全機能に対応する画面・コンポーネントが設計されているか |
| 1-G1-06 | セキュリティ設計 | 認証境界（Cookie/APIキー）、CSRF、不可視一貫仕様が設計に反映されているか |

**合格基準**: 全観点でレビュー指摘事項なし、または軽微な修正のみ

---

#### 1-2. プロジェクトセットアップ（実装）

| タスク | 詳細 |
|--------|------|
| バックエンドプロジェクト初期化 | Python 3.11+, FastAPI, SQLAlchemy, gitpython, pyproject.toml |
| フロントエンドプロジェクト初期化 | Vite + React 18 + TypeScript 5, Tailwind CSS, shadcn/ui |
| Docker Compose 構成 | backend, frontend (dev server), nginx (本番用) |
| 開発ツール設定 | ruff (lint/format), pytest, Vitest, Playwright (E2E) |
| CI パイプライン（基本） | lint + 型チェック + ユニットテスト |
| テストフィクスチャ基盤 | pytest conftest.py, Vitest setup, テスト用DB/Gitリポジトリ生成 |

**Docker Compose構成（Phase 1）**:
```yaml
services:
  backend:
    build: ./backend
    ports: ["8000:8000"]
    volumes:
      - ./backend:/app
      - repo-data:/data/repository
      - attachments-data:/data/attachments
  frontend:
    build: ./frontend
    ports: ["5173:5173"]   # 開発時のみ
  nginx:
    image: nginx:alpine
    ports: ["80:80", "443:443"]  # 本番用
```

#### ✅ G2: ソースレビュー（Step 1）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 1-G2-01 | プロジェクト構造 | ディレクトリ構成が設計書に準拠、不要ファイルがないか |
| 1-G2-02 | 依存関係 | pyproject.toml / package.json のバージョン固定・不要依存なし |
| 1-G2-03 | Docker構成 | Compose起動で全サービスが正常動作、ボリュームマウント正常 |
| 1-G2-04 | CI動作 | lint, 型チェック, テストの各ステージが正常に実行される |
| 1-G2-05 | テスト基盤 | フィクスチャ生成・クリーンアップが正しく動作する |

#### ✅ G3: 単体テスト（Step 1）

| # | テスト内容 | 合格基準 |
|---|------------|----------|
| 1-G3-01 | Docker Compose起動 | `docker compose up` で全サービスが起動し、ヘルスチェックが通る |
| 1-G3-02 | CIパイプライン | lint + 型チェック + サンプルテスト がGreen |
| 1-G3-03 | テストフィクスチャ | DB作成/破棄、Gitリポジトリ作成/破棄が正常動作 |
| 1-G3-04 | バックエンド起動 | FastAPI起動 → `/docs` でOpenAPIスキーマ表示 |
| 1-G3-05 | フロントエンド起動 | Vite dev server 起動 → ブラウザ表示 |

---

### Step 2: バックエンド — データモデル・Git連携（2.5週）

#### 2-1. 仕様書

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-05 | **SQLAlchemy モデル詳細設計** | 全テーブル定義、リレーション、インデックス、マイグレーション手順 |
| D-06 | **Gitサービス層インターフェース設計** | 全メソッドのシグネチャ、入出力型、例外定義 |
| D-07 | **添付ファイルサービス設計** | CAS保存フロー、バリデーションルール、SVG特別処理 |

#### ✅ G1: 仕様レビュー（Step 2）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 2-G1-01 | DB設計整合性 | Step 1のDBスキーマ設計書との一致、インデックス設計の妥当性 |
| 2-G1-02 | Gitサービス境界 | メソッドシグネチャがAPI仕様書（D-01）の要求を満たすか |
| 2-G1-03 | 添付ファイル仕様 | CAS保存、バリデーション、SVG処理が要件定義 2.2 に準拠 |
| 2-G1-04 | エラーハンドリング | 異常系（ファイル破損、Git操作失敗等）の例外定義が明確か |
| 2-G1-05 | SoT整合性 | Source of Truth定義（要件定義 2.1.4）と設計が一致しているか |

---

#### 2-2. 実装タスク

**DBモデル**:

| テーブル | 主要カラム | 備考 |
|----------|------------|------|
| users | id(UUID), username, email, password_hash, auth_type, is_active | bcryptハッシュ |
| groups | id(UUID), name, is_system | everyoneはis_system=true |
| user_groups | user_id, group_id | 多対多 |
| roles | id(UUID), name, is_system | admin, userはis_system=true |
| user_roles | user_id, role_id | 多対多 |
| acl | id, article_id, target_type, target_id, permission_level | target_type: user/group/role |
| sessions | id, user_id, expires_at, csrf_token | サーバーサイドセッション |
| attachments | hash(PK), content_type, size, created_at, unreferenced_since | CAS管理 |
| system_settings | key, value, updated_at | default_visibility等 |
| api_keys | id, key_hash, user_id, scope, expires_at, is_active | Phase 4で本格利用 |

**Gitサービス層**:

| 機能 | メソッド | 説明 |
|------|----------|------|
| リポジトリ初期化 | `init_repository()` | 初回起動時にnon-bareリポジトリを作成 |
| 記事作成 | `create_article(id, content, meta)` | content.md + meta.yaml を作成しコミット |
| 記事更新 | `update_article(id, content, meta)` | ファイル更新 + コミット |
| 記事取得 | `get_article(id)` | ワーキングツリーから読み取り |
| コミット履歴 | `get_history(id)` | 該当ディレクトリのコミットログ |
| 差分取得 | `get_diff(id, commit_hash)` | 指定コミットとの差分 |
| ロールバック | `rollback(id, commit_hash)` | 指定コミット時点に復元 + 新コミット |
| ETag取得 | `get_etag(id)` | 最新コミットハッシュを返す |

**添付ファイルサービス**:

| 機能 | 説明 |
|------|------|
| アップロード | SHA-256算出 → CAS保存 → DB登録 → meta.yaml更新 |
| ダウンロード | ハッシュからファイル取得（SVGは強制ダウンロード） |
| バリデーション | サイズ上限、拡張子、Content-Type整合性チェック |

#### ✅ G2: ソースレビュー（Step 2）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 2-G2-01 | モデル定義 | SQLAlchemyモデルが設計書D-05に準拠、型・制約が正確 |
| 2-G2-02 | マイグレーション | Alembicマイグレーションスクリプトが正常動作 |
| 2-G2-03 | Gitサービス | gitpython操作がD-06設計に準拠、例外処理が適切 |
| 2-G2-04 | 添付サービス | CAS保存ロジック、ハッシュ計算、バリデーション処理の正確性 |
| 2-G2-05 | セキュリティ | ファイル名正規化（パストラバーサル対策）、SVGヘッダー設定 |
| 2-G2-06 | コード品質 | ruff準拠、型ヒント付与、docstring記述 |

#### ✅ G3: 単体テスト（Step 2）

| # | テスト対象 | テスト内容 | 件数目安 |
|---|------------|------------|----------|
| 2-G3-01 | DBモデル | テーブル作成、制約チェック（NOT NULL, FK, UNIQUE） | 15件 |
| 2-G3-02 | DBモデル | マイグレーション正常動作（up/down） | 3件 |
| 2-G3-03 | Gitサービス | 記事CRUD（create/read/update） | 10件 |
| 2-G3-04 | Gitサービス | コミット生成・メッセージ形式検証 | 5件 |
| 2-G3-05 | Gitサービス | 履歴取得・差分表示 | 5件 |
| 2-G3-06 | Gitサービス | ロールバック（正常・存在しないコミット） | 5件 |
| 2-G3-07 | Gitサービス | ETag取得・比較 | 3件 |
| 2-G3-08 | 添付サービス | アップロード正常系（各許可拡張子） | 8件 |
| 2-G3-09 | 添付サービス | アップロード異常系（サイズ超過、不正拡張子、不正Content-Type） | 6件 |
| 2-G3-10 | 添付サービス | CAS重複排除（同一内容で2回アップロード） | 2件 |
| 2-G3-11 | 添付サービス | SVGのContent-Disposition / Content-Type検証 | 2件 |
| 2-G3-12 | meta.yaml | シリアライズ・デシリアライズ | 4件 |
| 2-G3-13 | meta.yaml | 必須フィールドバリデーション | 4件 |

**合格基準**: 全テスト合格、カバレッジ80%以上（サービス層）

---

### Step 3: バックエンド — 認証・認可（2週）

#### 3-1. 仕様書

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-08 | **認証フロー詳細設計** | ログイン → セッション発行 → CSRF トークン管理のシーケンス図 |
| D-09 | **認可判定ロジック設計** | RBAC + ACL の判定フロー、権限マトリクス、状態遷移図 |

#### ✅ G1: 仕様レビュー（Step 3）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 3-G1-01 | 認証設計 | Cookie属性（HttpOnly, SameSite, Secure）が要件定義 3.8.3 に準拠 |
| 3-G1-02 | CSRF対策 | CSRFトークンの生成・検証フローに漏れがないか |
| 3-G1-03 | 権限判定 | 判定フローが要件定義 3.6.4 に完全準拠（union方式、暗黙deny） |
| 3-G1-04 | 不可視仕様 | 要件定義 3.6.5 の全ケース（検索, Wiki, API, 管理画面）をカバー |
| 3-G1-05 | 状態遷移 | active↔deleted, active↔frozen の遷移制約が設計に反映されているか |
| 3-G1-06 | 依存性注入設計 | FastAPIのDependsチェーンが適切に設計されているか |

---

#### 3-2. 実装タスク

**認証**:

| 機能 | 詳細 |
|------|------|
| パスワード管理 | bcryptによるハッシュ化・検証 |
| ログイン | ユーザー名/パスワード検証 → セッション発行 |
| セッション管理 | DB保存、24時間有効期限、Cookie設定（HttpOnly, SameSite=Lax） |
| CSRFトークン | セッション作成時に生成、変更系リクエストで検証 |
| ログアウト | セッション削除 |

**認可**:

| 機能 | 詳細 |
|------|------|
| 権限判定関数 | `get_permission(user_id, article_id) → PermissionLevel` |
| 判定ロジック | ユーザー直接 ∪ グループ経由 ∪ ロール経由 → 最大権限採用 |
| デフォルト権限 | 記事作成時: 作成者=delete, everyone=default_visibility設定に従う |
| adminロール | 全記事にdelete権限（ACL自動付与） |
| 不可視一貫仕様 | 権限none → 404返却（403は使わない） |
| frozen一貫仕様 | status=frozen → 全ユーザーに404（管理画面を除く） |
| 記事状態遷移チェック | active↔deleted, active↔frozen のみ許可 |

**FastAPI依存性注入**:
```python
# 認証ミドルウェア（全UIエンドポイント共通）
async def get_current_user(request: Request) -> User: ...

# 権限チェック
def require_permission(level: PermissionLevel):
    async def dependency(user: User, article_id: UUID) -> Article: ...
    return Depends(dependency)

# 管理者チェック
async def require_admin(user: User = Depends(get_current_user)) -> User: ...
```

#### ✅ G2: ソースレビュー（Step 3）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 3-G2-01 | 認証実装 | bcryptラウンド数、セッションID生成のエントロピー |
| 3-G2-02 | Cookie設定 | HttpOnly, SameSite=Lax, Secure（本番）の設定確認 |
| 3-G2-03 | CSRF検証 | 変更系エンドポイントすべてでCSRFトークン検証が実装されているか |
| 3-G2-04 | 権限判定 | 判定ロジックがD-09設計に完全準拠 |
| 3-G2-05 | 不可視一貫 | 403が**一切**返されず、すべて404になっているか |
| 3-G2-06 | 状態遷移 | 禁止遷移が確実にブロックされるか |

#### ✅ G3: 単体テスト（Step 3）

| # | テスト対象 | テスト内容 | 件数目安 |
|---|------------|------------|----------|
| 3-G3-01 | 認証 | ログイン成功（正しい認証情報） | 2件 |
| 3-G3-02 | 認証 | ログイン失敗（不正パスワード、存在しないユーザー、無効ユーザー） | 3件 |
| 3-G3-03 | セッション | セッション有効期限切れ時の認証拒否 | 2件 |
| 3-G3-04 | セッション | ログアウト後のセッション無効化 | 1件 |
| 3-G3-05 | CSRF | CSRFトークンなし/不一致での変更系API拒否 | 3件 |
| 3-G3-06 | 認可 | 各権限レベルでのアクセス可否（none/read/write/delete × CRUD操作） | 12件 |
| 3-G3-07 | 認可 | ユーザー直接付与の権限判定 | 3件 |
| 3-G3-08 | 認可 | グループ経由の権限判定 | 3件 |
| 3-G3-09 | 認可 | ロール経由の権限判定 | 3件 |
| 3-G3-10 | 認可 | 複数経路の最大権限採用（user=read, group=write → write） | 3件 |
| 3-G3-11 | 認可 | everyoneグループのデフォルト権限（open設定） | 2件 |
| 3-G3-12 | 認可 | everyoneグループのデフォルト権限（closed設定） | 2件 |
| 3-G3-13 | 不可視一貫 | none権限記事 → 各APIで404応答 | 6件 |
| 3-G3-14 | frozen一貫 | frozen記事 → 各APIで404応答 | 6件 |
| 3-G3-15 | 管理画面 | include_hidden=true でnone権限記事を取得 | 2件 |
| 3-G3-16 | 管理画面 | include_frozen=true でfrozen記事を取得 | 2件 |
| 3-G3-17 | 状態遷移 | active→deleted → active（成功） | 1件 |
| 3-G3-18 | 状態遷移 | active→frozen → active（成功） | 1件 |
| 3-G3-19 | 状態遷移 | deleted→frozen（拒否） | 1件 |
| 3-G3-20 | 状態遷移 | frozen→deleted（拒否） | 1件 |

**合格基準**: 全テスト合格、カバレッジ90%以上（認証・認可モジュール）

---

#### ✅ G4: I/Fレビュー（バックエンド基盤 — Step 2+3完成時点）

Step 2（データモデル・Git）+ Step 3（認証・認可）で「バックエンド基盤」が機能として完成する。  
この時点でサービス層の公開インターフェースをレビューする。

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 23-G4-01 | サービス層I/F一貫性 | GitService, AttachmentService, AuthService, PermissionService のメソッド命名・引数・戻り値の統一性 |
| 23-G4-02 | 例外体系 | カスタム例外クラスの階層・HTTPステータスコードへのマッピングが一貫しているか |
| 23-G4-03 | 依存性注入チェーン | `get_current_user → require_permission → サービス呼び出し` の依存チェーンに不整合がないか |
| 23-G4-04 | DB↔Git整合性 | DB操作（ACL設定等）とGit操作（記事作成等）の呼び出し順序・トランザクション境界が適切か |
| 23-G4-05 | 型定義 | Pydanticスキーマ（リクエスト/レスポンス）の定義がAPI仕様書D-01と一致するか |

#### ✅ G5: 機能間結合テスト（バックエンド基盤 — Step 2+3）

| # | テストシナリオ | 検証内容 |
|---|---------------|----------|
| 23-G5-01 | 認証 → 記事作成 | ログイン → セッション取得 → 記事作成 → デフォルト権限確認（ACL + Git） |
| 23-G5-02 | 認証 → 権限判定 → 記事取得 | ログイン → 権限あり記事を取得 → 権限なし記事は404 |
| 23-G5-03 | 認証 → 添付アップロード → Git連携 | ログイン → 画像アップロード → meta.yaml反映確認 → CASファイル確認 |
| 23-G5-04 | 認証 → 管理操作 | admin認証 → freeze操作 → 通常ユーザーで404確認 → unfreeze → 取得成功 |
| 23-G5-05 | 認可 → 状態遷移 → Git | 記事削除 → status=deleted コミット確認 → 復元 → status=active コミット確認 |
| 23-G5-06 | 認可 → 検索 → 権限フィルタ | 複数記事作成（権限混在） → 検索 → 権限ありのみ返却確認 |

**合格基準**: 全シナリオ合格

---

### Step 4: バックエンド — API実装（2.5週）

#### 4-1. 仕様書

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-10 | **OpenAPI スキーマ最終版** | FastAPI自動生成スキーマのレビュー・調整結果 |
| D-11 | **エラーレスポンス仕様** | ステータスコード + エラーコード体系 + レスポンスボディ形式 |

#### ✅ G1: 仕様レビュー（Step 4）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 4-G1-01 | OpenAPIスキーマ | D-01（API仕様書）と自動生成スキーマD-10が一致するか |
| 4-G1-02 | エラーコード体系 | エラーコードが一意で、クライアント側で判別可能か |
| 4-G1-03 | ページネーション | 一覧APIのページネーションパラメータ・レスポンス形式が統一されているか |
| 4-G1-04 | ETag仕様 | 楽観ロックのETag生成・比較仕様が要件定義 3.2.3 に準拠 |

---

#### 4-2. 実装タスク

**記事CRUD API**:

| エンドポイント | 主要ロジック |
|----------------|--------------|
| GET /articles | DBベース検索（タイトル・タグLIKE）、権限フィルタ、ページネーション |
| POST /articles | UUID生成 → Git作成 → ACL設定（デフォルト権限） |
| GET /articles/{id} | 権限チェック → Git読み取り → ETagヘッダー付与 |
| PUT /articles/{id} | If-Matchチェック → 権限チェック(write以上) → Git更新 |
| DELETE /articles/{id} | 権限チェック(delete) → meta.yaml status=deleted → コミット |

**バージョン管理API**:

| エンドポイント | 主要ロジック |
|----------------|--------------|
| GET /articles/{id}/history | Git log を整形して返却 |
| GET /articles/{id}/diff/{commit} | unified diff を生成 |
| POST /articles/{id}/rollback | Git checkout → 新コミット |

**その他API**:

| カテゴリ | エンドポイント群 |
|----------|------------------|
| 添付ファイル | アップロード（バリデーション付き）、ダウンロード（SVG特別処理） |
| タグ | タグ一覧、タグ別記事一覧 |
| Wiki | メニュー構造取得・更新（structure.yaml CRUD） |
| 検索 | DBベースLIKE検索（タイトル、タグ）、権限フィルタ付き |
| 管理 | 不可視/frozen記事一覧、freeze/unfreeze/restore操作 |
| ユーザー管理 | ユーザーCRUD（admin専用） |

#### ✅ G2: ソースレビュー（Step 4）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 4-G2-01 | エンドポイント網羅 | D-01で定義した全エンドポイントが実装されているか |
| 4-G2-02 | 認証・認可適用 | すべてのエンドポイントに適切な認証・認可チェックがあるか |
| 4-G2-03 | 楽観ロック | ETag生成・If-Match比較・409応答の実装正確性 |
| 4-G2-04 | エラーハンドリング | D-11のエラーコード体系に準拠した例外処理 |
| 4-G2-05 | バリデーション | リクエストボディ・パスパラメータのPydanticバリデーション |
| 4-G2-06 | レスポンス形式 | レスポンスモデルが型定義どおりか |

#### ✅ G3: 単体テスト（Step 4）

| # | テスト対象 | テスト内容 | 件数目安 |
|---|------------|------------|----------|
| 4-G3-01 | 記事CRUD API | 作成（正常・バリデーションエラー） | 4件 |
| 4-G3-02 | 記事CRUD API | 取得（正常・存在しない・権限なし=404） | 4件 |
| 4-G3-03 | 記事CRUD API | 更新（正常・ETag一致・ETag不一致=409・権限不足） | 5件 |
| 4-G3-04 | 記事CRUD API | 削除（正常・権限不足・既に削除済み） | 3件 |
| 4-G3-05 | バージョン管理 | 履歴取得（正常・空履歴） | 2件 |
| 4-G3-06 | バージョン管理 | 差分取得（正常・存在しないコミット） | 2件 |
| 4-G3-07 | バージョン管理 | ロールバック（正常・存在しないコミット） | 2件 |
| 4-G3-08 | 添付API | アップロード（正常・各種異常系） | 6件 |
| 4-G3-09 | 添付API | ダウンロード（正常・SVG・存在しないハッシュ） | 3件 |
| 4-G3-10 | タグAPI | タグ一覧・タグ別記事一覧 | 4件 |
| 4-G3-11 | Wiki API | 構造取得・更新（正常・不正構造） | 4件 |
| 4-G3-12 | 検索API | キーワード検索・タグフィルタ・権限フィルタ | 6件 |
| 4-G3-13 | 管理API | freeze/unfreeze/restore（正常・権限不足） | 6件 |
| 4-G3-14 | ユーザー管理API | CRUD（正常・バリデーションエラー・権限不足） | 8件 |
| 4-G3-15 | ページネーション | offset/limit の動作、境界値 | 3件 |
| 4-G3-16 | エラーレスポンス | 各エラーコードの応答形式確認 | 5件 |

**合格基準**: 全テスト合格、カバレッジ85%以上（APIルーター層）

---

#### ✅ G4: I/Fレビュー（バックエンドAPI完成 — Step 4完成時点）

Step 4完成により「バックエンド全体」が機能として完成する。  
フロントエンドに公開するAPIインターフェース全体をレビューする。

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 4-G4-01 | OpenAPIスキーマ完全性 | `/openapi.json` 出力がD-10と完全一致するか |
| 4-G4-02 | レスポンスモデル一貫性 | 全エンドポイントのレスポンス形式（フィールド名、型、null許容）が統一されているか |
| 4-G4-03 | エラーレスポンス一貫性 | D-11で定義したエラーコード体系が全エンドポイントで統一的に使用されているか |
| 4-G4-04 | 認証ヘッダー | Cookie/CSRF の設定・返却がブラウザ互換であるか（SameSite, Secure, HttpOnly） |
| 4-G4-05 | ETag/If-Match | 楽観ロック対応エンドポイントのヘッダー仕様がHTTP仕様に準拠しているか |
| 4-G4-06 | フロントエンド型生成 | `openapi-typescript` で生成した型がコンパイルエラーなく生成されるか |

#### ✅ G5: 機能間結合テスト（バックエンドAPI — Step 2+3+4）

| # | テストシナリオ | 検証内容 |
|---|---------------|----------|
| 4-G5-01 | 記事ライフサイクル完全 | 認証 → 作成 → 取得(ETag) → 編集(If-Match) → 履歴確認 → ロールバック → 論理削除 → 復元 |
| 4-G5-02 | 添付ファイル完全 | 認証 → 記事作成 → 添付アップロード → meta.yaml反映 → 添付ダウンロード → SVGダウンロード |
| 4-G5-03 | 権限モデル完全 | ユーザー/グループ/ロール混在環境で各API操作の権限判定が正確 |
| 4-G5-04 | 楽観ロック完全 | 2クライアントでの同時更新 → 409 → 差分情報取得 → 再取得(新ETag) → 更新成功 |
| 4-G5-05 | 不可視一貫テスト完全 | none記事に対する全APIエンドポイント（一覧,詳細,検索,Wiki,タグ）の404応答 |
| 4-G5-06 | frozen一貫テスト完全 | frozen記事に対する全APIエンドポイントの404応答 + 管理APIでは取得可能 |
| 4-G5-07 | 検索+権限+ページネーション | 多数記事（権限混在）で検索 → ページネーション → 全ページで権限フィルタ適用確認 |
| 4-G5-08 | Wiki+記事+権限 | Wikiメニュー取得 → 権限なし記事がメニューから除外されることを確認 |
| 4-G5-09 | ユーザー管理→権限反映 | ユーザーをグループ追加 → 権限変更が即座に反映されるか |
| 4-G5-10 | セッション→全API | ログイン → 各APIアクセス → ログアウト → 全API拒否 → 再ログイン → 復帰 |

**合格基準**: 全シナリオ合格

---

### Step 5: フロントエンド — 基盤・レイアウト（1.5週）

> **Note**: Step 1完了後、バックエンド（Step 2〜4）と並行して着手可能。  
> モックAPI（MSW等）を使用してバックエンド完成前に開発を進める。

#### 5-1. 仕様書

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-12 | **画面遷移図** | 全ページ・モーダルの遷移フロー |
| D-13 | **ワイヤーフレーム** | 主要画面のレイアウト定義 |
| D-14 | **コンポーネントツリー** | 共通コンポーネントの責務・Props定義 |

#### ✅ G1: 仕様レビュー（Step 5）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 5-G1-01 | 画面網羅性 | 要件定義Phase 1の全機能に対応する画面が遷移図に含まれるか |
| 5-G1-02 | UX一貫性 | ナビゲーション構造・操作パターンが画面間で統一されているか |
| 5-G1-03 | API対応 | 各画面が使用するAPIエンドポイントが明確に対応付けられているか |
| 5-G1-04 | コンポーネント設計 | Props定義がAPI型（openapi-typescript生成型）と整合するか |

---

#### 5-2. 実装タスク

**プロジェクト構造**:
```
frontend/src/
├── api/           # openapi-typescript 生成型 + fetchクライアント
├── components/
│   ├── ui/        # shadcn/ui（Button, Dialog, Input, etc.）
│   ├── layout/    # AppShell, Sidebar, Header, Breadcrumb
│   ├── editor/    # MarkdownEditor, MarkdownPreview
│   └── wiki/      # WikiMenu, WikiTree
├── features/
│   ├── articles/  # ArticleList, ArticleDetail, ArticleForm
│   ├── auth/      # LoginForm, AuthGuard
│   ├── search/    # SearchBar, SearchResults
│   └── admin/     # AdminPanel, UserManagement
├── hooks/         # useAuth, useArticle, useSearch, useDebounce
├── stores/        # authStore, uiStore (Zustand)
├── routes/        # ページコンポーネント
├── lib/           # markdown-it設定, DOMPurify設定, utils
└── types/         # 共通型定義
```

**基盤タスク**:

| タスク | 詳細 |
|--------|------|
| Vite + React + TS セットアップ | tsconfig, vite.config（proxyの設定含む） |
| Tailwind + shadcn/ui 導入 | テーマ設定、基本UIコンポーネント追加 |
| React Router 設定 | ルート定義、認証ガード |
| Zustand ストア | authStore（ユーザー状態）, uiStore（サイドバー開閉等） |
| TanStack Query 設定 | QueryClient、デフォルトオプション |
| API型生成 | openapi-typescript + openapi-fetch 設定 |
| レイアウトコンポーネント | AppShell（左サイドバー + メインコンテンツ領域） |
| 認証画面 | ログインフォーム、認証状態管理 |
| MSW セットアップ | バックエンドモックAPI（並行開発用） |

**画面一覧（Phase 1）**:

| パス | 画面 | 説明 |
|------|------|------|
| `/login` | ログイン | ユーザー名/パスワード入力 |
| `/` | ダッシュボード | 最近の記事一覧 |
| `/articles` | 記事一覧 | 検索・フィルタ付き一覧 |
| `/articles/new` | 記事作成 | Markdownエディタ |
| `/articles/:id` | 記事閲覧 | Markdownビューア |
| `/articles/:id/edit` | 記事編集 | Markdownエディタ（既存記事） |
| `/articles/:id/history` | 履歴 | コミット一覧・差分表示 |
| `/wiki/:id` | Wiki表示 | 左メニュー + 記事ビュー |
| `/search` | 検索結果 | 検索結果一覧 |
| `/admin` | 管理画面 | ユーザー管理・システム設定 |
| `/admin/articles` | 記事管理 | 不可視/frozen記事の管理 |

#### ✅ G2: ソースレビュー（Step 5）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 5-G2-01 | ディレクトリ構成 | D-04/D-14 のコンポーネント設計に準拠した構造になっているか |
| 5-G2-02 | 型安全性 | TypeScript strict mode、any型の排除 |
| 5-G2-03 | API型生成 | openapi-typescript出力がOpenAPIスキーマと一致 |
| 5-G2-04 | ルーティング | 画面一覧の全パスが定義され、認証ガードが適用されているか |
| 5-G2-05 | ストア設計 | Zustandストアの責務分離が適切か |
| 5-G2-06 | MSWモック | バックエンドAPIの主要エンドポイントがモックされているか |

#### ✅ G3: 単体テスト（Step 5）

| # | テスト対象 | テスト内容 | 件数目安 |
|---|------------|------------|----------|
| 5-G3-01 | レイアウト | AppShellの表示、サイドバー開閉 | 3件 |
| 5-G3-02 | ルーティング | 各パスへの遷移、存在しないパスの404 | 5件 |
| 5-G3-03 | 認証ガード | 未認証時のリダイレクト | 2件 |
| 5-G3-04 | ログインフォーム | バリデーション（空欄、不正形式） | 3件 |
| 5-G3-05 | ログインフォーム | ログイン成功/失敗のフロー（MSW使用） | 2件 |
| 5-G3-06 | Zustandストア | authStore: ログイン/ログアウト状態管理 | 3件 |
| 5-G3-07 | API型 | 生成された型がコンパイルエラーなし | 1件 |

**合格基準**: 全テスト合格

---

### Step 6: フロントエンド — 機能実装（2.5週）

#### 6-1. 仕様書

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-15 | **Markdownエディタ仕様** | CodeMirror拡張一覧、プレビュー同期方式、オートセーブ仕様 |
| D-16 | **Markdownレンダリング仕様** | markdown-it プラグイン構成、サニタイズルール、添付画像解決方式 |
| D-17 | **競合処理UI仕様** | 409応答時の差分表示・上書き確認ダイアログの画面設計 |

#### ✅ G1: 仕様レビュー（Step 6）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 6-G1-01 | エディタ仕様 | CodeMirror拡張が要件定義 3.2.1 に準拠 |
| 6-G1-02 | レンダリング仕様 | サニタイズルールが要件定義 3.8.1（XSS対策）に準拠 |
| 6-G1-03 | 外部画像ブロック | 許可リスト外の外部画像が確実にブロックされる設計か |
| 6-G1-04 | 競合処理UI | 楽観ロック（要件定義 3.2.3）のUXフローが適切か |
| 6-G1-05 | アクセシビリティ | キーボード操作、スクリーンリーダー対応の考慮があるか |

---

#### 6-2. 実装タスク

**Markdownエディタ・ビューア**:

| タスク | 詳細 |
|--------|------|
| CodeMirror 6 セットアップ | Markdown言語サポート、シンタックスハイライト |
| Split View | エディタ（左）+ プレビュー（右）の同時表示 |
| markdown-it 設定 | CommonMark + GFM拡張、添付画像プラグイン |
| DOMPurify 統合 | 生HTML除去、javascript:スキーム除去、外部画像ブロック |
| 添付画像挿入 | ドラッグ&ドロップ or ボタンからアップロード → `![alt](attachment:hash)` 挿入 |
| 目次自動生成 | 見出しから目次コンポーネントを生成 |
| オートセーブ | localStorage にドラフト保存（一定間隔） |
| 明示的保存 | 保存ボタン → API呼び出し（ETag付き） |

**記事管理**:

| タスク | 詳細 |
|--------|------|
| 記事一覧 | ページネーション、タグフィルタ、キーワード検索 |
| 記事作成/編集 | タイトル・パス・タグ入力 + Markdownエディタ |
| 記事閲覧 | Markdownレンダリング + メタデータ表示 |
| 論理削除 | 削除確認ダイアログ → API呼び出し |
| バージョン履歴 | コミット一覧表示、差分ビューア |
| ロールバック | 確認ダイアログ → API呼び出し |
| 競合処理 | 409応答時の差分表示 + 上書き確認ダイアログ |

**Wiki**:

| タスク | 詳細 |
|--------|------|
| Wikiメニュー | ツリー構造の表示（structure.yaml準拠） |
| メニュー編集 | ボタン操作（↑↓→←🗑）による並び替え・構造編集（管理者） |
| 記事ビュー | メニュー選択 → 記事表示 |

**管理画面**:

| タスク | 詳細 |
|--------|------|
| ユーザー管理 | ユーザーCRUD、ロール割当 |
| 記事管理 | 不可視/frozen記事の確認・操作 |
| システム設定 | default_visibility切替、外部画像許可リスト |

#### ✅ G2: ソースレビュー（Step 6）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 6-G2-01 | サニタイズ実装 | DOMPurifyの設定が D-16 に準拠、バイパスの余地がないか |
| 6-G2-02 | 外部画像ブロック | markdown-itプラグインで許可リスト外URL画像が確実にブロックされるか |
| 6-G2-03 | API呼び出し | TanStack Queryの利用パターン、エラーハンドリングが適切か |
| 6-G2-04 | 楽観ロック連携 | ETag送信・409ハンドリング・差分表示UIの実装正確性 |
| 6-G2-05 | コンポーネント品質 | Props型定義、不要な再レンダリング防止、アクセシビリティ属性 |
| 6-G2-06 | ストア利用 | Zustandストアの更新パターンが適切か（不要な全体再レンダリングなし） |

#### ✅ G3: 単体テスト（Step 6）

| # | テスト対象 | テスト内容 | 件数目安 |
|---|------------|------------|----------|
| 6-G3-01 | エディタ | Markdown入力→プレビュー表示の同期 | 3件 |
| 6-G3-02 | サニタイザー | `<script>` 除去 | 2件 |
| 6-G3-03 | サニタイザー | `javascript:` スキーム除去 | 2件 |
| 6-G3-04 | サニタイザー | `<img onerror>` 除去 | 2件 |
| 6-G3-05 | サニタイザー | 外部画像URL（許可リスト外）のブロック | 3件 |
| 6-G3-06 | 添付画像 | 添付記法 `![](attachment:hash)` のレンダリング | 2件 |
| 6-G3-07 | 目次生成 | 見出しからの目次生成（h1〜h6、ネスト） | 3件 |
| 6-G3-08 | オートセーブ | localStorageへの保存・復元 | 2件 |
| 6-G3-09 | 記事一覧 | 一覧表示・ページネーション操作（MSW使用） | 3件 |
| 6-G3-10 | 記事フォーム | タイトル・タグのバリデーション | 3件 |
| 6-G3-11 | 削除ダイアログ | 確認→削除API呼び出し | 2件 |
| 6-G3-12 | 競合ダイアログ | 409応答時の差分表示・上書き確認 | 3件 |
| 6-G3-13 | Wikiメニュー | ツリー構造の表示 | 2件 |
| 6-G3-14 | 管理画面 | ユーザー一覧・作成フォーム | 3件 |

**合格基準**: 全テスト合格

---

#### ✅ G4: I/Fレビュー（フロントエンド完成 — Step 5+6完成時点）

フロントエンド全体が機能として完成した時点で、バックエンドとの接続インターフェースをレビューする。

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 56-G4-01 | API呼び出し網羅 | バックエンドD-01で定義した全エンドポイントがフロントエンドから呼び出し可能か |
| 56-G4-02 | 型整合性 | openapi-typescript生成型とフロントエンドの利用箇所で型不一致がないか |
| 56-G4-03 | エラーハンドリング | D-11のエラーコード体系に対応したUI表示が全画面で実装されているか |
| 56-G4-04 | 認証フロー | Cookie送信（credentials: include）、CSRFトークン送信が全API呼び出しで正しいか |
| 56-G4-05 | ETag連携 | 記事取得時のETag保持 → 更新時のIf-Match送信が正しく実装されているか |
| 56-G4-06 | ページネーション | バックエンドのページネーションレスポンスをフロントエンドが正しくパースしているか |

#### ✅ G5: 機能間結合テスト（フロントエンド↔バックエンド — Step 5+6）

> **前提**: バックエンド（Step 4完了済み）の実APIに接続して実施する。

| # | テストシナリオ | 検証内容 |
|---|---------------|----------|
| 56-G5-01 | 認証連携 | ログインフォーム → Cookie設定 → 認証必須ページ表示 → ログアウト → リダイレクト |
| 56-G5-02 | 記事作成→閲覧 | エディタでMarkdown入力 → 保存 → 記事一覧に反映 → 閲覧画面でレンダリング確認 |
| 56-G5-03 | 記事編集→履歴 | 記事編集 → 保存 → 履歴画面でコミット表示 → 差分表示確認 |
| 56-G5-04 | 添付アップロード→表示 | エディタで画像ドロップ → アップロードAPI → 記事内表示 → ダウンロードAPI |
| 56-G5-05 | 楽観ロック連携 | 記事編集 → 別リクエストで更新 → 保存→409 → 差分ダイアログ → 上書きまたはキャンセル |
| 56-G5-06 | 検索連携 | 検索バー入力 → 検索API呼び出し → 結果表示 → 記事遷移 |
| 56-G5-07 | Wiki連携 | Wikiメニュー取得 → ツリー表示 → 記事選択 → 記事取得・表示 |
| 56-G5-08 | 管理画面連携 | admin認証 → freeze API → 通常画面で404確認 → unfreeze → 復帰 |
| 56-G5-09 | 権限反映 | 権限なし記事のURLアクセス → 404ページ表示（403ではない） |
| 56-G5-10 | タグ連携 | 記事にタグ付与 → タグ一覧API → タグ別記事一覧に反映確認 |

**合格基準**: 全シナリオ合格

---

### Step 7: システムテスト・E2Eテスト（1週）

> Step 7はシステム全体の最終検証であり、個別のG1〜G5ではなく  
> **システムテスト（ST）ゲート**として位置づける。

#### 7-1. テスト仕様書

| 成果物ID | 成果物 | 内容 |
|----------|--------|------|
| D-18 | **E2Eテストシナリオ一覧** | 主要ユーザーフローのPlaywrightテストケース |
| D-19 | **セキュリティテスト項目** | XSS, CSRF, 権限バイパス等のチェックリスト |

#### ✅ 仕様レビュー（Step 7）

| # | レビュー観点 | 確認内容 |
|---|-------------|----------|
| 7-R-01 | シナリオ網羅性 | Phase 1の全機能が最低1つのE2Eシナリオでカバーされているか |
| 7-R-02 | セキュリティ網羅性 | OWASP Top 10の該当項目がカバーされているか |
| 7-R-03 | 要件トレーサビリティ | 要件定義v0.7.0の各Phase 1項目からテストケースへの追跡が可能か |

---

#### 7-2. E2Eテスト（Playwright）

| # | シナリオ | 操作フロー |
|---|----------|------------|
| E-01 | 新規ユーザーフロー | ログイン → ダッシュボード表示 → 記事作成 → 閲覧 |
| E-02 | 記事編集フロー | 記事一覧 → 記事選択 → 編集 → プレビュー確認 → 保存 |
| E-03 | 添付ファイル | 記事編集中に画像ドロップ → プレビューで表示確認 |
| E-04 | バージョン管理 | 記事編集 → 保存 → 履歴表示 → 差分確認 → ロールバック |
| E-05 | Wiki操作 | Wikiメニュー表示 → 記事選択 → 記事表示 |
| E-06 | 検索 | 検索バー入力 → 結果表示 → 記事遷移 |
| E-07 | 競合検出 | 2タブで同一記事編集 → 後発保存で競合ダイアログ |
| E-08 | 管理操作 | 管理画面 → 記事freeze → 通常UIで404確認 → unfreeze |
| E-09 | 権限確認 | 一般ユーザーで管理画面アクセス → リダイレクト |
| E-10 | レスポンシブ | 主要画面のモバイル幅表示確認 |

#### 7-3. セキュリティテスト

| # | 項目 | テスト内容 |
|---|------|------------|
| S-01 | XSS | Markdown内 `<script>`, `<img onerror>`, `javascript:` の無害化 |
| S-02 | XSS | 外部画像URL（許可リスト外）のブロック |
| S-03 | CSRF | CSRFトークンなしでの変更系APIの拒否 |
| S-04 | 権限バイパス | URLパラメータ操作による権限外記事へのアクセス→404 |
| S-05 | パストラバーサル | 添付ファイル名に `../` を含むアップロードの無害化 |
| S-06 | SVGセキュリティ | SVGファイルのContent-Disposition: attachment確認 |
| S-07 | セッション固定 | ログイン後のセッションID再生成 |
| S-08 | 情報漏洩 | エラーレスポンスにスタックトレースが含まれない |
| S-09 | 存在推測防止 | 権限なし記事への全API（REST, 直接URL）で403ではなく404 |

#### ✅ システムテスト合格基準

| 項目 | 基準 |
|------|------|
| E2Eテスト | 全10シナリオ合格 |
| セキュリティテスト | 全9項目合格 |
| 性能（目安） | 記事表示1秒以内、検索2秒以内（ローカル環境、100記事規模） |
| 未解決バグ | Critical: 0件、Major: 0件、Minor: 3件以下 |

---

## 3. Phase 2〜5: 概要計画

> Phase 2以降も同じゲート構造（G1〜G5）を適用する。以下は概要のみ記載。

### Phase 2: 検索強化（7週）

| ステップ | 期間 | ゲート |
|----------|------|--------|
| 設計 | 1週 | G1: OpenSearchスキーマ、Celeryタスク、RRFスコアリング設計レビュー |
| インフラ | 1週 | G2/G3: Docker Compose追加のソースレビュー + 起動テスト |
| 実装 | 3週 | G2/G3: インデックス更新キュー、検索エンジン、権限フィルタのレビュー + 単体テスト |
| I/Fレビュー+結合テスト | 1週 | G4: 検索APIのI/Fレビュー、G5: 検索↔権限↔記事CRUD結合テスト |
| システムテスト | 1週 | 検索精度テスト、500件上限テスト、フォールバック（OpenSearch停止時）テスト |

### Phase 3: AI機能（7週）

| ステップ | 期間 | ゲート |
|----------|------|--------|
| 設計 | 1週 | G1: LiteLLM統合設計、プロンプトテンプレート、RAGパイプラインレビュー |
| 実装 | 3週 | G2/G3: 要約生成、タグ提案、RAG Q&A、記事生成のレビュー + 単体テスト |
| I/Fレビュー+結合テスト | 1.5週 | G4: LLMサービスI/Fレビュー、G5: LLM↔記事↔検索の結合テスト |
| システムテスト | 1.5週 | 実モデルでの品質テスト、タイムアウト・リトライテスト |

### Phase 4: エンタープライズ（9週）

| ステップ | 期間 | ゲート |
|----------|------|--------|
| 設計 | 1.5週 | G1: LDAP連携、REST API認証、MCP、監査ログスキーマ設計レビュー |
| 実装 | 4.5週 | G2/G3: 各機能のレビュー + 単体テスト |
| I/Fレビュー+結合テスト | 1.5週 | G4: REST API/MCPのI/Fレビュー、G5: LDAP↔認可↔API↔監査ログ結合テスト |
| システムテスト | 1.5週 | LDAP統合テスト、APIキースコープテスト、監査ログ完全性テスト |

### Phase 5: 拡張機能（継続的）

各機能は独立して開発・リリース。機能ごとにG1〜G5を適用。

| 優先度 | 機能 | 期間目安 |
|--------|------|----------|
| 高 | クラウドLLM API対応 | 1週 |
| 高 | Mermaid対応 | 1週 |
| 中 | 内部リンク・記事埋め込み | 2.5週 |
| 中 | oEmbed対応 | 2週 |
| 中 | PDFエクスポート | 1.5週 |
| 低 | Knowledge/twilogインポート | 2.5週 |
| 低 | 物理削除 | 2.5週 |
| 低 | 複数記事タブ表示 | 1.5週 |

---

## 4. ゲート構造サマリ

### 4.1 Phase 1 ゲート一覧（全体俯瞰）

```
Step 1 [基盤構築]
  ├── G1: 仕様レビュー（API仕様, DB設計, Git構造, コンポーネント設計）
  ├── G2: ソースレビュー（プロジェクト構成, Docker, CI）
  └── G3: 単体テスト（起動確認, テスト基盤動作）
          │
Step 2 [データモデル・Git]
  ├── G1: 仕様レビュー（SQLAlchemy設計, Gitサービス設計, 添付設計）
  ├── G2: ソースレビュー（モデル, Gitサービス, 添付サービス）
  └── G3: 単体テスト（~72件）
          │
Step 3 [認証・認可]
  ├── G1: 仕様レビュー（認証フロー, 認可判定ロジック）
  ├── G2: ソースレビュー（認証, Cookie, CSRF, 権限判定, 不可視一貫）
  └── G3: 単体テスト（~57件）
          │
  ★ G4: I/Fレビュー（バックエンド基盤: サービス層I/F統一性）
  ★ G5: 機能間結合テスト（認証×記事×添付×権限 — 6シナリオ）
          │
Step 4 [API実装]
  ├── G1: 仕様レビュー（OpenAPIスキーマ最終版, エラーコード体系）
  ├── G2: ソースレビュー（全エンドポイント実装）
  └── G3: 単体テスト（~67件）
          │
  ★ G4: I/Fレビュー（バックエンドAPI完成: フロントエンド向けI/F確認）
  ★ G5: 機能間結合テスト（全バックエンド機能横断 — 10シナリオ）
          │
Step 5 [FE基盤]（Step 2〜4と並行可）
  ├── G1: 仕様レビュー（画面遷移図, ワイヤーフレーム, コンポーネントツリー）
  ├── G2: ソースレビュー（プロジェクト構成, ルーティング, ストア, API型生成）
  └── G3: 単体テスト（~19件）
          │
Step 6 [FE機能]
  ├── G1: 仕様レビュー（エディタ仕様, レンダリング仕様, 競合処理UI仕様）
  ├── G2: ソースレビュー（エディタ, サニタイザー, 記事管理, Wiki, 管理画面）
  └── G3: 単体テスト（~35件）
          │
  ★ G4: I/Fレビュー（FE完成: バックエンドAPI接続I/F確認）
  ★ G5: 機能間結合テスト（FE↔BE全機能横断 — 10シナリオ）
          │
Step 7 [システムテスト]
  ├── 仕様レビュー（E2Eシナリオ, セキュリティテスト項目）
  ├── E2Eテスト（10シナリオ）
  ├── セキュリティテスト（9項目）
  └── ★ システムテスト合格判定
```

### 4.2 テスト規模サマリ

| 種別 | 件数目安 | ツール |
|------|----------|--------|
| バックエンド単体テスト | ~196件 | pytest |
| フロントエンド単体テスト | ~54件 | Vitest |
| 機能間結合テスト | ~26シナリオ | pytest + httpx / Vitest + 実API |
| E2Eテスト | 10シナリオ | Playwright |
| セキュリティテスト | 9項目 | 手動 + 自動 |
| **合計** | **~295件+** | |

### 4.3 テスト環境

| 環境 | 用途 | DB | Git |
|------|------|----|-----|
| 単体テスト | 個別ロジック検証 | SQLite（インメモリ） | 一時ディレクトリ |
| 結合テスト | 機能間連携検証 | SQLite（ファイル） | 一時ディレクトリ |
| E2E/システムテスト | ブラウザ全体検証 | SQLite（ファイル） | 一時ディレクトリ |

### 4.4 CI/CDパイプライン

```
Push → Lint (ruff + eslint) → 型チェック (mypy + tsc)
     → 単体テスト (pytest + vitest)             [G3相当: 全Push]
     → 結合テスト (pytest + vitest + 実API)     [G5相当: PR時]
     → E2Eテスト (playwright)                   [ST相当: mainブランチのみ]
     → Docker イメージビルド                     [タグ時]
```

---

## 5. 成果物一覧

### 5.1 仕様書（Phase 1）

| ID | 成果物 | 作成Step | レビューゲート |
|----|--------|----------|----------------|
| D-01 | API仕様書（OpenAPI 3.1） | Step 1 | 1-G1 |
| D-02 | DBスキーマ設計書 | Step 1 | 1-G1 |
| D-03 | Gitリポジトリ構造設計 | Step 1 | 1-G1 |
| D-04 | コンポーネント設計書 | Step 1 | 1-G1 |
| D-05 | SQLAlchemy モデル詳細設計 | Step 2 | 2-G1 |
| D-06 | Gitサービス層I/F設計 | Step 2 | 2-G1 |
| D-07 | 添付ファイルサービス設計 | Step 2 | 2-G1 |
| D-08 | 認証フロー詳細設計 | Step 3 | 3-G1 |
| D-09 | 認可判定ロジック設計 | Step 3 | 3-G1 |
| D-10 | OpenAPIスキーマ最終版 | Step 4 | 4-G1 |
| D-11 | エラーレスポンス仕様 | Step 4 | 4-G1 |
| D-12 | 画面遷移図 | Step 5 | 5-G1 |
| D-13 | ワイヤーフレーム | Step 5 | 5-G1 |
| D-14 | コンポーネントツリー | Step 5 | 5-G1 |
| D-15 | Markdownエディタ仕様 | Step 6 | 6-G1 |
| D-16 | Markdownレンダリング仕様 | Step 6 | 6-G1 |
| D-17 | 競合処理UI仕様 | Step 6 | 6-G1 |
| D-18 | E2Eテストシナリオ一覧 | Step 7 | 7-R |
| D-19 | セキュリティテスト項目 | Step 7 | 7-R |

### 5.2 コード成果物

| ID | 成果物 | 検証ゲート |
|----|--------|------------|
| C-01 | バックエンド（FastAPI） | 2-G2〜4-G3, 23-G5, 4-G5 |
| C-02 | フロントエンド（React SPA） | 5-G2〜6-G3, 56-G5 |
| C-03 | Docker Compose | 1-G3 |
| C-04 | テストコード | 各Step G3, G5 |
| C-05 | CI設定（GitHub Actions） | 1-G3 |

---

## 6. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| gitpythonの性能問題（大量記事時） | 記事取得・検索が遅延 | Step 2 の G3 で1,000記事規模の性能テストを追加 |
| SQLiteの同時書き込みロック | 複数ユーザー利用時のエラー | Step 2 の G3 でPostgreSQLでも動作確認 |
| Markdown XSSの抜け穴 | セキュリティ脆弱性 | Step 6 G3 + Step 7 S-01〜S-02 で多重検証 |
| 楽観ロックのUX | 競合時のユーザー体験劣化 | Step 6 G1 で競合処理UI仕様を入念にレビュー |
| レビュー・テスト工数超過 | スケジュール遅延 | 軽微な指摘は Issue 化して後続修正、ブロッカーのみ即時対応 |
| フロントエンド技術負債 | 開発速度低下 | 型生成による自動同期、56-G4 でI/F整合性を保証 |
