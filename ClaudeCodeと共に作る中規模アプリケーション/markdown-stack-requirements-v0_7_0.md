# Markdown Stack 要件定義書

**バージョン**: 0.7.0  
**作成日**: 2025-06-13  
**更新日**: 2026-02-23  
**ステータス**: 開発着手前最終レビュー版

---

## 1. プロジェクト概要

### 1.1 プロジェクト名
Markdown Stack

### 1.2 コンセプト
Markdownベースの知識管理システム。LLMを活用した要約・タグ付け支援・RAG Q&A機能を備え、チームでの知識蓄積と活用を支援する。

### 1.3 ターゲットユーザー
- 利用規模: 数人〜数十人（最大100人未満）
- 利用形態: オンプレミス環境での運用

### 1.4 主な特徴
- Markdownによるドキュメント管理
- Git的な差分管理（履歴・ロールバック対応）
- ローカルLLMを基本とした AI機能（クラウドAPIもオプション対応）
- OpenSearchによるハイブリッド検索（BM25 + ベクトル検索）
- RAGによる知識ベースQ&A
- Wiki風のナビゲーション UI

---

## 2. データモデル

### 2.1 記事（Article）

#### 2.1.1 識別子
| 項目 | 仕様 |
|------|------|
| ID | UUID v4（作成時に付与、不変） |
| パス | メタデータとして管理（リネーム可能、IDは維持） |
| タイトル | メタデータとして管理（パスとは独立） |

#### 2.1.2 ディレクトリ構造
```
repository/
├── articles/
│   └── {uuid}/
│       ├── content.md        # 本文（Markdown）
│       └── meta.yaml         # メタデータ
├── chunks/
│   └── {uuid}/
│       ├── content.md
│       └── meta.yaml
└── wiki/
    └── {wiki-id}/
        └── structure.yaml    # Wikiメニュー構造定義

attachments/                   # Git管理外
└── {content-hash}.{ext}       # 添付ファイル本体
```

#### 2.1.3 メタデータ（meta.yaml）

**注意**: 権限（ACL）はDBが正（Source of Truth）であり、meta.yamlには含めない。

```yaml
id: "550e8400-e29b-41d4-a716-446655440000"
title: "記事タイトル"
path: "/技術メモ/Python/FastAPI入門"
type: "article"  # article | chunk
status: "active"  # active | deleted | frozen（緊急遮断）
created_at: "2025-06-13T10:00:00Z"
updated_at: "2025-06-13T15:30:00Z"
created_by: "user-uuid"
updated_by: "user-uuid"
tags:
  - "Python"
  - "FastAPI"
  - "Web開発"
attachments:
  - hash: "a1b2c3d4e5f6..."
    filename: "diagram.png"
    content_type: "image/png"
    size: 102400
# LLM生成メタデータ
summary:
  content: "この記事はFastAPIの基本的な使い方を..."
  generated_at: "2025-06-13T16:00:00Z"
  model: "qwen2.5:32b"
  source_version: "abc123def"  # 生成元の記事コミットハッシュ
suggested_tags:
  tags:
    - tag: "API設計"
      confidence: 0.85
  generated_at: "2025-06-13T16:00:00Z"
  model: "qwen2.5:32b"
```

**`suggested_tags` の構造説明**:
- `tags`: 提案されたタグのリスト（各タグに `tag` 名と `confidence` スコアを持つ）
- `generated_at`, `model`: 一回の生成処理に対するメタ情報（`summary` と同構造）

#### 2.1.4 データの正（Source of Truth）定義
| データ | 正（SoT） | 備考 |
|--------|-----------|------|
| 記事本文 | Git（content.md） | 履歴・差分管理 |
| 記事メタデータ（タグ、要約等） | Git（meta.yaml） | 履歴・差分管理 |
| 権限（ACL） | **DB** | Git復元時もACLは別管理、監査ログ対象 |
| ユーザー・グループ・ロール | DB | - |
| 検索インデックス | OpenSearch（キャッシュ） | 正はGit、差異時は再同期 |

### 2.2 添付ファイル（Attachment）

#### 2.2.1 保存方針
| 項目 | 仕様 |
|------|------|
| 保存場所 | Git管理外の専用ディレクトリ |
| ファイル名 | コンテンツハッシュ（SHA-256） |
| 重複排除 | 同一内容は1ファイルのみ保存（Content-Addressable Storage） |
| 参照管理 | 記事のmeta.yamlに参照情報を記録（Git管理対象） |
| バックアップ | 添付ディレクトリを定期バックアップ |

#### 2.2.2 ライフサイクル（参照切れ・GC）
CASで保存された添付ファイルは、参照する記事がなくなっても自動削除されない。未参照ファイルの管理方針:

| 項目 | 仕様 |
|------|------|
| 検出方式 | 定期バッチで全記事のmeta.yamlをスキャンし、未参照ハッシュを検出 |
| 未参照記録 | 検出時に `attachments.unreferenced_since` をDBに記録 |
| 削除猶予期間 | 未参照判定日から30日（設定可能） |
| 実行タイミング | 管理者が管理画面から手動実行（v1.0） |
| 自動実行 | 将来検討（Phase 5以降） |
| 削除前確認 | 削除対象一覧を表示し、管理者が確認後に実行 |
| 監査 | GC実行は監査ログに記録（削除ファイル数、実行者、日時） |

**GC処理フロー**:
```
1. 全記事のmeta.yamlから参照されているハッシュを収集
2. 添付ディレクトリ内の全ファイルと比較
3. 未参照ファイルを検出
   - 初回検出: DBに unreferenced_since = 現在日時 を記録
   - 既存未参照: unreferenced_since を維持（再参照された場合はレコード削除）
4. unreferenced_since から30日以上経過したファイルを削除候補としてリスト
5. 管理者が確認・承認後に削除実行
6. 監査ログに記録
```

**DBスキーマ（attachments テーブル）**:
| カラム | 型 | 説明 |
|--------|-----|------|
| hash | VARCHAR(64) | SHA-256ハッシュ（PK） |
| content_type | VARCHAR(100) | MIMEタイプ |
| size | BIGINT | ファイルサイズ（バイト） |
| created_at | TIMESTAMP | 初回アップロード日時 |
| unreferenced_since | TIMESTAMP NULL | 未参照検出日時（参照中はNULL） |

**CASにおけるファイル名の扱い**:
- 同一ハッシュのファイルが異なるファイル名でアップロードされる可能性がある（例: `diagram.png` と `図1.png` が同一内容）
- 各記事での表示ファイル名は **meta.yaml の `attachments[].filename`** が正（SoT）
- attachments テーブルにはファイル名を持たない（ファイル名はmeta.yaml側で記事ごとに管理）

#### 2.2.3 アップロード制約
| 項目 | 制約 |
|------|------|
| 最大サイズ | 50MB/ファイル（設定可能） |
| 許可拡張子 | 画像: png, jpg, jpeg, gif, webp |
|            | 画像（特殊）: svg（ダウンロードのみ、インライン表示禁止） |
|            | ドキュメント: pdf, docx, xlsx, pptx, txt, csv |
|            | その他: zip（設定で拡張可能） |
| ファイル名 | 正規化（パストラバーサル対策、特殊文字除去） |
| Content-Type | 拡張子との整合性チェック |
| ウイルススキャン | オプション（ClamAV連携、設定で有効化） |

#### 2.2.4 SVGファイルの取り扱い（セキュリティ対策）
SVGはスクリプトを含む可能性があるため、特別な取り扱いを行う。

| 操作 | 動作 |
|------|------|
| アップロード | **許可**（拡張子・Content-Type検証あり） |
| 記事内での参照 | リンクとして表示（クリックでダウンロード） |
| インライン表示 | **禁止**（`<img src="...svg">` では表示しない） |
| ダウンロード | **許可** |
| サムネイル | 汎用アイコン表示（SVGの内容はプレビューしない） |

**配信時のHTTPヘッダー（SVG）**:
```
Content-Type: application/octet-stream
Content-Disposition: attachment; filename="example.svg"
X-Content-Type-Options: nosniff
```

**記事内での表示例**:
```markdown
添付ファイル: [architecture.svg](attachment:abc123) をご参照ください。
```
↓ レンダリング結果
```
添付ファイル: 📎 architecture.svg [ダウンロード] をご参照ください。
```

**SVGをインライン表示したい場合の代替手段**:
1. PNG/JPEGに変換してアップロード（推奨）
2. Mermaid記法で直接記述（システム内でSVGを動的生成）【将来対応】
3. 外部サービスのoEmbed埋め込み（draw.io、Figma等）【将来対応】

**将来拡張（Phase 5以降で検討）**:
- サーバーサイドでPNG変換してサムネイル表示
- sandbox付きiframe + CSP で隔離プレビュー

### 2.3 タグ（Tag）

| 項目 | 仕様 |
|------|------|
| 大文字小文字 | 区別しない（正規化して小文字で保存） |
| 最大文字数 | 50文字 |
| 禁止文字 | カンマ、セミコロン、改行、制御文字 |
| 最大タグ数 | 20個/記事 |
| 同義語 | 将来検討（v1.0では未対応） |

### 2.4 チャンク（Chunk）
| 項目 | 仕様 |
|------|------|
| 定義 | 小さな単位のメモ。記事生成の素材 |
| 構造 | 記事と同一（content.md + meta.yaml） |
| 区別 | meta.yamlの `type: chunk` で識別 |
| 履歴管理 | 記事と同様にGit管理対象 |
| 統合 | 複数チャンクを選択 → LLMで記事生成 |

---

## 3. 機能要件

### 3.1 コンテンツ管理

#### 3.1.1 ドキュメント（記事）
| 項目 | 内容 | v1.0対応 |
|------|------|----------|
| 形式 | Markdown | ✓ |
| 保存先 | ファイルシステム（Git管理下） | ✓ |
| 対応記法 | CommonMark + GFM拡張 | ✓ |
| 画像埋め込み | 添付画像の表示 | ✓ |
| Mermaid図 | mermaid.js によるダイアグラム | **将来対応（Phase 5）** |
| oEmbed | 外部コンテンツの埋め込み | **将来対応（Phase 5）** |

#### 3.1.2 Markdown拡張記法
| 記法 | 用途 | 例 | v1.0対応 |
|------|------|-----|----------|
| 添付参照 | 添付ファイルの表示 | `![alt](attachment:hash)` | ✓ |
| 内部リンク（正式） | 他記事への参照 | `[[550e8400-e29b-41d4-a716-446655440000]]` | **将来対応（Phase 5）** |
| 内部リンク（入力補助） | タイトルで検索→UUID変換 | `[[記事タイトル]]` → 保存時にUUIDに正規化 | **将来対応（Phase 5）** |
| 記事埋め込み | 他記事の内容を展開 | `{{embed:記事UUID}}` | **将来対応（Phase 5）** |

**内部リンクの詳細仕様【将来対応（Phase 5）】**:
| 項目 | 仕様 |
|------|------|
| 正式記法 | `[[UUID]]`（保存後はすべてこの形式） |
| タイトル入力 | エディタで `[[` 入力時にタイトル候補を表示、選択でUUID挿入 |
| 保存時変換 | `[[タイトル]]` は可視範囲内で検索し、一意ならUUIDに変換 |
| 複数候補時 | 選択ダイアログを表示（ユーザーが選択） |
| 候補なし | 警告を表示、リンクは無効として保存 |
| 不可視記事へのリンク | リンク切れとして表示（存在は示唆しない） |
| リンク自動更新 | 不要（UUIDで解決するため、リネーム/移動の影響なし） |

#### 3.1.3 バージョン管理（Git）
| 項目 | 仕様 |
|------|------|
| 管理方式 | gitpython による通常リポジトリ（non-bare） |
| コミット単位 | 明示的な保存操作ごと（オートセーブはドラフト扱い、コミット対象外） |
| コミット対象 | content.md + meta.yaml を同一コミットに含める |
| コミットメッセージ | 自動生成（操作種別 + ユーザー + タイムスタンプ） |
| 差分表示 | 本文の差分をUI表示 |
| ロールバック | 任意のコミットに復元可能 |

**リポジトリ形式の選定理由（non-bare）**:
- ベアリポジトリはワーキングツリーがなく、ファイルの読み書きに `git cat-file` / `git hash-object` + `git update-index` 等の低レベル操作が必要となり、実装・デバッグの難易度が高い
- 本システムではアプリケーションサーバーが単一のGitリポジトリを管理する構成のため、通常リポジトリ（non-bare）で十分
- gitpython のワーキングツリー操作APIを活用でき、実装がシンプルになる
- ワーキングツリーとインデックスの整合性はアプリケーション側で管理（直接のファイルシステム操作は行わない）

**ロールバックとDB（ACL）の整合性ルール**:

Gitロールバックは記事内容のみを復元し、DB管理データ（ACL等）は復元しない。

| データ | ロールバック時の扱い |
|--------|----------------------|
| 記事本文（content.md） | **復元される** |
| 記事メタデータ（meta.yaml） | **復元される**（タグ、要約等） |
| 権限（ACL） | **復元されない**（現在のACLを維持） |
| ユーザー・グループ・ロール | **復元されない**（DB管理） |
| OpenSearch インデックス | 復元後に該当記事を**自動で再インデックス** |

**運用ルール**:
- 「Gitロールバックは記事内容のみ復元し、権限設定は維持される」ことをユーザーに明示
- ロールバック実行は監査ログに記録（対象記事、復元先コミット、実行者、日時）
- ロールバック後、OpenSearchへの再インデックスは自動実行（数秒以内に反映）

#### 3.1.4 削除の扱い
| 項目 | 仕様 |
|------|------|
| 削除方式 | 論理削除（meta.yamlの `status: deleted` を更新） |
| UI表示 | 削除済み記事は通常UIに非表示 |
| 検索対象 | 削除済みは検索対象外 |
| 復元 | 管理者またはDelete権限保持者が復元可能 |
| 物理削除 | **v1.0では提供しない**（Phase 5以降で検討） |
| ID維持 | 削除後もUUIDは再利用しない |

**物理削除をv1.0で提供しない理由**:
- Git履歴からの削除は `git filter-repo` 等が必要で運用が複雑
- 法務/規制要件が明確でない段階での実装は過剰
- 運用設計（停止/バックアップ/監査/復旧手順）が未確立

#### 3.1.5 緊急遮断（強制不可視）
| 項目 | 仕様 |
|------|------|
| 用途 | 誤設定や問題発生時に即座に記事を非公開化 |
| 設定権限 | 管理者（adminロール）のみ |
| 状態 | meta.yamlの `status: frozen` |
| 効果 | 全ユーザーに対して不可視（管理者含む、管理画面でのみ確認可能） |
| 解除 | 管理者が明示的に解除 |
| 監査 | 設定/解除は監査ログの必須イベント |

#### 3.1.6 リネーム・移動
| 項目 | 仕様 |
|------|------|
| 対象 | meta.yamlの `path` および `title` を更新 |
| ID | 変更なし（UUIDは維持） |
| 履歴 | リネーム/移動もコミット履歴に記録 |
| リンク解決 | UUIDベースのため影響なし（自動更新不要） |

### 3.2 エディタ・ビューア

#### 3.2.1 Markdownエディタ
| 項目 | 内容 | v1.0対応 |
|------|------|----------|
| 編集モード | ソースコード編集 + リアルタイムプレビュー（split view） | ✓ |
| WYSIWYG | 将来検討 | **将来対応** |
| 補完機能（画像挿入） | 添付画像の挿入補助 | ✓ |
| 補完機能（内部リンク） | 内部リンク候補の表示・挿入 | **将来対応（Phase 5）** |
| 補完機能（Mermaid） | Mermaidテンプレートの挿入 | **将来対応（Phase 5）** |
| オートセーブ | ドラフトとしてローカル保存（ブラウザ or サーバー） | ✓ |
| 明示的保存 | Gitコミット対象 | ✓ |

#### 3.2.2 ビューア
| 項目 | 内容 | v1.0対応 |
|------|------|----------|
| 画像レンダリング | 添付画像の表示 | ✓ |
| Mermaid図 | mermaid.js による動的レンダリング | **将来対応（Phase 5）** |
| oEmbed | 外部コンテンツの埋め込み表示 | **将来対応（Phase 5）** |
| 目次 | 見出しからの自動生成 | ✓ |
| 内部リンク | クリックで該当記事に遷移 | **将来対応（Phase 5）** |
| 印刷/エクスポート | PDF出力 | **将来対応（Phase 5）** |

#### 3.2.3 同時編集・競合
| 項目 | 仕様 |
|------|------|
| ロック方式 | 楽観ロック（ETagベース） |
| 競合検出 | 保存時にETagを比較し、不一致なら競合と判定 |
| 競合時の挙動 | 後勝ち + 警告表示 |
| 警告内容 | 「他のユーザーが編集しました。上書きしますか？」+ 差分表示 |
| 上書き前の元データ | 履歴として保存（ロールバック可能） |

**ETagの生成方式**:
- 記事取得時にGitの最新コミットハッシュをETagとしてレスポンスヘッダーに含める
- 保存リクエスト時に `If-Match` ヘッダーでETagを送信し、サーバー側で現在のコミットハッシュと比較
- 不一致の場合は `409 Conflict` を返し、クライアントに差分表示・上書き確認を促す

### 3.3 Wiki機能

#### 3.3.1 ナビゲーション
| 項目 | 内容 |
|------|------|
| レイアウト | 左: メニュー（ツリー構造）、右: 記事ビュー |
| メニュー定義 | structure.yaml で階層構造を定義 |
| 階層 | 疑似的な階層構造（UIでの見せ方のみ） |
| 複数Wiki | 複数のWiki構造を定義可能 |

#### 3.3.2 structure.yaml 例
```yaml
wiki_id: "main"
title: "メインWiki"
structure:
  - title: "はじめに"
    article_id: "uuid-1"
  - title: "技術ドキュメント"
    children:
      - title: "Python"
        children:
          - title: "FastAPI入門"
            article_id: "uuid-2"
          - title: "Django Tips"
            article_id: "uuid-3"
      - title: "インフラ"
        article_id: "uuid-4"
  - title: "運用マニュアル"
    article_id: "uuid-5"
```

#### 3.3.3 複数記事の統合表示【将来対応（Phase 5）】
| 項目 | 内容 |
|------|------|
| 方式 | タブ形式で複数記事を1画面に表示 |
| 用途 | 関連記事の比較、チャンクの統合作業 |
| 最大タブ数 | 10（設定可能） |

### 3.4 検索機能

#### 3.4.1 検索エンジン
| 項目 | 内容 |
|------|------|
| バックエンド | Phase 1: DBベース簡易検索、Phase 2以降: OpenSearch |
| 役割 | 検索インデックス + キャッシュ |
| 正データ | ファイルシステム（Git管理下）が正 |

**Phase別の検索方式**:
| Phase | 検索方式 | 依存コンポーネント |
|-------|----------|---------------------|
| Phase 1 | DBベース簡易検索（タイトル・タグのLIKE検索） | SQLite / PostgreSQL のみ |
| Phase 2以降 | OpenSearch ハイブリッド検索（BM25 + ベクトル） | OpenSearch + Celery + Redis |

#### 3.4.2 検索方式（Phase 2以降）
| 方式 | 説明 |
|------|------|
| BM25検索 | キーワードベースの全文検索 |
| ベクトル検索 | 埋め込みモデルによる意味検索 |
| ハイブリッド | BM25 + ベクトル検索の複合（RRFでスコア統合） |

#### 3.4.3 埋め込みモデル（Phase 2以降）
| 項目 | 内容 |
|------|------|
| 基本 | nomic-embed-text（Ollama経由） |
| オプション | OpenAI Embeddings、その他クラウドAPI |

#### 3.4.4 OpenSearch整合性戦略（Phase 2以降）
| 項目 | 仕様 |
|------|------|
| 更新方式 | イベント駆動（保存/削除/権限変更時にキューイング） |
| 反映タイミング | 準即時（数秒以内、キュー処理） |
| 権限フィルタ | 検索結果に対して権限を再チェックしてフィルタ |
| フィルタ方式 | 段階的取得方式（後述） |
| 削除反映 | 論理削除時にインデックスからも除外 |
| 再索引 | 管理機能として全記事の再インデックスを提供 |
| 障害時 | OpenSearch停止時は検索機能が縮退（タグ/タイトルでの簡易検索にフォールバック） |

**権限フィルタの処理フロー（段階的取得方式）**:
```
1. OpenSearchでスコア順に上位100件を取得
2. 各記事に対してDBのACLをチェック
3. 可視権限のある記事のみをフィルタ
4. ページサイズ（デフォルト20件）分が集まればそこで返却
5. 20件に満たない場合、次の100件を追加取得してフィルタを継続
6. 最大500件まで取得を繰り返す（性能上限）
7. 500件チェックしても20件に満たない場合は、その時点の結果を返却
```

**設計判断とトレードオフ**:
- 最大500件の上限は、極端にACLが細分化された環境で可視記事が少ない場合に取りこぼしが発生しうる
- ただし本システムのターゲット（100人未満）では、500件以内に十分な可視記事が含まれると想定
- 将来的にACLをOpenSearchインデックスに含めるアプローチ（検索段階でフィルタ）も検討可能だが、ACL変更時の再インデックスコストとのトレードオフがあるため、v1.0では後処理フィルタ方式を採用

#### 3.4.5 検索結果のユーザー体験（UX）方針

権限フィルタにより検索結果が少なくなる場合があるが、「不可視の一貫仕様」に従い、権限で除外されたことは示唆しない。

| 項目 | 方針 |
|------|------|
| 結果表示 | 「検索結果: X件」のみ表示 |
| 権限による除外 | 言及しない（存在を示唆しない） |
| 0件の場合 | 「該当する記事が見つかりませんでした」と表示 |
| ヘルプ/FAQ | 「検索結果は閲覧権限のある記事のみ表示されます」と案内 |

**理由**:
- 「権限がないため表示されません」と示すと、存在を示唆してしまう
- 不可視の一貫仕様（404応答、存在を示唆しない）と整合させる

### 3.5 AI/LLM機能

#### 3.5.1 LLMプロバイダー
| 優先度 | プロバイダー | モデル例 |
|--------|--------------|----------|
| 基本 | Ollama | qwen2.5:32b, llama3.1:70b |
| 基本 | llama.cpp | mistral-small-3.2 |
| オプション | Anthropic Claude API | claude-sonnet-4-20250514 |
| オプション | OpenAI API | gpt-4o |
| オプション | Google AI | gemini-2.0-flash |
| オプション | Azure OpenAI | 各種モデル |
| オプション | Amazon Bedrock | 各種モデル |

#### 3.5.2 AI機能一覧
| 機能 | 説明 |
|------|------|
| 要約生成 | 記事の要約を生成（meta.yamlに保存） |
| タグ提案 | 記事内容からタグを自動提案（confidence付き） |
| RAG Q&A | 蓄積した知識ベースを元に質問応答 |
| 記事生成 | 複数チャンクを統合して記事を生成 |

#### 3.5.3 LLM生成物の管理
| 項目 | 仕様 |
|------|------|
| 保存先 | meta.yaml内に記録 |
| メタデータ | 生成日時、モデル名、元記事のコミットハッシュ |
| 再生成 | 記事更新時に手動で再生成（自動再生成はオプション） |
| 再現性 | 同一プロンプト・モデルで再生成可能な情報を保持 |

#### 3.5.4 LLM運用設定
| 項目 | デフォルト | 説明 |
|------|------------|------|
| タイムアウト | 120秒 | 生成処理の最大待機時間 |
| リトライ | 2回 | 失敗時の再試行回数 |
| フォールバック | なし | オプションで代替モデルを設定可能 |
| 同時リクエスト | 2 | LLMへの同時リクエスト数制限 |

### 3.6 認証・認可

#### 3.6.1 認証方式
| 方式 | 説明 |
|------|------|
| ローカルアカウント | システム内でユーザー管理 |
| LDAP連携 | 外部LDAPサーバーとの認証連携 |
| 併用 | 両方式の併用可能（環境に応じて選択） |

#### 3.6.2 ユーザー管理
| 項目 | 内容 |
|------|------|
| グループ | ユーザーをグループに所属させる（複数所属可） |
| ロール | 権限セットをロールとして定義 |
| システムロール | admin（管理者）、user（一般）を標準提供 |
| システムグループ | `everyone`（全ユーザーが自動所属）を標準提供 |

#### 3.6.3 アクセス権限レベル
| レベル | 値 | 説明 |
|--------|-----|------|
| 不可視 | none | 記事の存在を認識できない（明示的な権限がない場合のデフォルト） |
| 読み取り専用 | read | 閲覧のみ可能 |
| 読み書き | write | 閲覧・編集が可能 |
| 削除可能 | delete | 閲覧・編集・削除が可能 |

#### 3.6.4 権限モデル（RBAC + ACL）

**基本原則**:
- 明示的なdenyは存在しない
- 権限が付与されていない = アクセス不可（暗黙のdeny）
- 複数経路で権限がある場合は**最大権限を採用**（union）

**権限の優先度**:
```
最終権限 = max(ユーザー直接付与, 所属グループの権限, 所属ロールの権限)
```

**権限判定フロー**:
```
1. ユーザーに直接付与された権限を取得
2. ユーザーの所属グループに付与された権限を取得
3. ユーザーの所属ロールに付与された権限を取得
4. すべての権限のうち最大レベルを採用
5. いずれも付与されていなければ「不可視」
```

**デフォルト権限（システム設定で切替可能）**:

| 設定 | 説明 | 推奨環境 |
|------|------|----------|
| `default_visibility: open` | 新規記事作成時に `everyone` グループへ `read` 権限を自動付与 | **デフォルト**。ナレッジ共有を重視するチーム |
| `default_visibility: closed` | 新規記事作成時に作成者のみ権限付与（他は不可視） | 機密性の高い情報を扱う組織 |

**いずれの設定でも共通**:
| 状況 | デフォルト |
|------|------------|
| 新規記事作成時（作成者） | `delete` 権限 |
| 管理者（adminロール） | すべての記事に `delete` 権限 |

**`everyone` グループ**:
- すべてのユーザーが自動的に所属するシステムグループ
- 管理者が `everyone` に対する権限を変更可能（例: `read` → `write` に引き上げ）
- 個別記事から `everyone` の権限を削除すれば、その記事のみ非公開にできる
- `everyone` グループからのユーザー除外は不可（システム管理）

**設計理由**:
- ナレッジ管理システムの主目的は「チームでの知識蓄積と活用」（1.2 コンセプト）であり、デフォルト公開が自然
- 記事作成のたびに閲覧者を個別設定する運用負荷を回避
- 機密情報を扱う組織向けに `closed` モードも用意し、柔軟に対応

**権限継承**:
- Wikiの階層構造に基づく継承は**行わない**（シンプル化）
- 各記事に個別に権限を設定

#### 3.6.5 「不可視」の一貫仕様

「不可視（none）」権限の記事および「緊急遮断（frozen）」状態の記事は、以下のすべてにおいて存在しないものとして扱う:

| 機能 | none（権限なし） | frozen（緊急遮断） |
|------|------------------|---------------------|
| 検索結果 | 表示されない | 表示されない |
| Wikiメニュー | 表示されない | 表示されない |
| 内部リンク `[[...]]` | リンク切れとして表示 | リンク切れとして表示 |
| 記事埋め込み `{{embed:...}}` | 展開されない | 展開されない |
| REST API (`/api/v1/*`) | 404 Not Found | 404 Not Found |
| MCP (`/api/mcp/*`) | 404 Not Found | 404 Not Found |
| UI API (`/api/ui/*`) | 404 Not Found | 404 Not Found |
| URL直接アクセス | 404 Not Found | 404 Not Found |
| 管理者（通常UI） | 表示されない | 表示されない |
| 管理者（管理画面） | **閲覧可能** | **閲覧可能** |

**重要**: すべてのケースで **404 Not Found** を返し、403 Forbidden は使用しない（存在を示唆しないため）。

**管理者の不可視記事確認**:
- 管理者であっても**通常UIでは不可視記事は表示されない**（v1.0）
- 不可視記事・凍結記事の確認は**管理画面（`/admin/*`）でのみ可能**
- これにより「不可視の一貫仕様」を厳格に維持し、実装・運用の複雑化を回避

**管理画面での確認**:
| エンドポイント | 用途 | 認可 |
|----------------|------|------|
| `/api/ui/admin/articles?include_hidden=true` | 不可視記事を含めて取得 | adminロールのみ |
| `/api/ui/admin/articles?include_frozen=true` | 凍結記事を含めて取得 | adminロールのみ |

**記事状態の遷移**:
```
active ←→ deleted（論理削除・復元）
active ←→ frozen（緊急遮断・解除）
deleted → frozen（不可）
frozen → deleted（不可、先にactiveに戻す必要あり）
```

**遷移制約の理由**:
- `deleted → frozen`: deletedは既に不可視であり、frozenにする実益がない。操作の意図が不明確になるため禁止
- `frozen → deleted`: frozenは管理者による意図的な遮断。直接deletedにすると遮断解除の判断を経ずに状態が変わるため、一度activeに戻してから削除する運用とする

### 3.7 外部連携

#### 3.7.1 認証方式の境界

**エンドポイント分離**:
| エンドポイント | 用途 | 認証方式 |
|----------------|------|----------|
| `/api/ui/*` | ブラウザUI専用 | Cookieセッション |
| `/api/v1/*` | 外部連携（REST API） | APIキー |
| `/api/mcp/*` | MCP連携 | APIキー |

**UI向けAPI（Cookieセッション）**:
| 項目 | 仕様 |
|------|------|
| 認証 | サーバーサイドセッション + Cookie |
| CSRF対策 | CSRFトークン必須（SameSite=Lax と併用） |
| セッション有効期限 | 24時間（設定可能） |
| セキュアCookie | HTTPS環境で `Secure`, `HttpOnly`, `SameSite=Lax` |

**外部連携API（APIキー）**:
| 項目 | 仕様 |
|------|------|
| 認証 | APIキー（Authorizationヘッダー: `Bearer {api_key}`） |
| スコープ | read / write / admin |
| 有効期限 | 設定可能（デフォルト無期限、推奨1年） |
| ローテーション | 新キー発行 → 旧キー無効化 |
| 即時無効化 | 管理画面から即座に無効化可能 |
| 発行上限 | ユーザーあたり10個まで |

**APIキースコープと記事権限のマッピング**:

APIキーのスコープは、記事に対する操作可否を制限する。記事自体の権限（ACL）との組み合わせで最終的な操作可否が決まる。

| APIキースコープ | 許可される操作 | 記事権限との関係 |
|-----------------|----------------|------------------|
| read | 記事の閲覧、検索 | 記事権限が read 以上の記事のみ |
| write | 閲覧 + 記事の作成・編集 | 記事権限が write 以上の記事のみ編集可 |
| admin | すべての操作（削除含む） | 記事ACLチェックは維持（下記参照） |

**操作可否の判定**:
```
最終操作可否 = min(APIキースコープ, 記事のACL権限)

例1: APIキー=write, 記事ACL=read → 閲覧のみ可
例2: APIキー=read, 記事ACL=delete → 閲覧のみ可
例3: APIキー=write, 記事ACL=write → 閲覧・編集可
例4: APIキー=admin, 記事ACL=read → 閲覧のみ可（ACLチェック維持）
```

**adminスコープAPIキーのセキュリティ対策**:

APIキーはセッション認証より漏洩リスクが高い（有効期限が長い、自動ツールに埋め込まれる等）ため、adminスコープには追加の制約を設ける。

| 項目 | 仕様 |
|------|------|
| ACLチェック | **維持**（adminスコープでもACLバイパスしない） |
| 管理操作 | ユーザー管理・権限変更・システム設定等の管理操作が可能 |
| 発行権限 | admin APIキーの発行はadminロール保持者のみ |
| 有効期限 | admin スコープは最大有効期限90日（設定可能、無期限不可） |
| IP制限 | admin スコープはIP許可リストの設定を推奨（設定で必須化可能） |
| 監査 | admin APIキーの全操作を監査ログに記録 |

**設計理由**:
- admin APIキーでもACLをバイパスしないことで、APIキー漏洩時の被害範囲を限定
- 管理操作（ユーザー管理、システム設定等）はACLとは独立した権限であり、adminスコープで許可
- admin権限による全記事へのアクセスが必要な場合は、対象記事にadminロールのACLを設定する（3.6.4のデフォルト権限で自動設定済み）

#### 3.7.2 REST API
| 項目 | 内容 |
|------|------|
| 対象操作 | 記事のCRUD、検索、タグ操作、添付アップロード |
| 認証 | APIキー（Bearer Token） |
| 認可 | APIキー所有者の権限に基づく |
| 形式 | JSON |
| バージョニング | URLパス（`/api/v1/...`） |
| レート制限 | 1000リクエスト/時間（設定可能） |

#### 3.7.3 MCP (Model Context Protocol)
| 項目 | 内容 |
|------|------|
| 対象操作 | 記事の読み書き、検索 |
| 認証 | APIキー |
| 用途 | LLMツールからの直接アクセス |

### 3.8 セキュリティ

#### 3.8.1 Markdownレンダリング（XSS対策）
| 項目 | 仕様 |
|------|------|
| 生HTML | 禁止（サニタイズして除去） |
| 許可タグ | なし（Markdown記法のみ） |
| リンク | `javascript:` スキームは除去 |
| 画像（添付） | 添付ファイルのみ表示可 |
| 画像（外部URL） | **既定で禁止**（許可リスト方式、3.8.4参照） |
| Mermaid | mermaid.js によるレンダリング（SVG出力、scriptタグ禁止）【将来対応】 |
| サニタイザー | DOMPurify または bleach（Python側） |

#### 3.8.2 oEmbedセキュリティ【将来対応（Phase 5）】
| 項目 | 仕様 |
|------|------|
| 許可ドメイン | ホワイトリスト方式（設定ファイルで管理） |
| デフォルト許可 | **なし**（管理者が明示的に許可を設定） |
| 追加可能サービス例 | YouTube, Twitter/X, Vimeo, SlideShare, Speaker Deck |
| タイムアウト | 5秒 |
| キャッシュ | 24時間（設定可能） |
| オフライン環境 | リンクテキストとして表示（埋め込みプレビューなし） |
| SSRF対策 | プライベートIPレンジへのリクエストを禁止 |

**oEmbed運用方針**:
- 企業環境では情報漏えい・コンプライアンスリスクを考慮し、**デフォルトは無効**
- 管理者が許可するサービスを明示的にホワイトリストに追加
- 許可リストの変更は監査ログに記録

#### 3.8.3 セッション管理
UI向けAPI（`/api/ui/*`）で使用するセッション管理:

| 項目 | 仕様 |
|------|------|
| 方式 | サーバーサイドセッション + Cookie |
| 有効期限 | 24時間（設定可能） |
| CSRF対策 | CSRFトークン必須 |
| セキュアCookie | HTTPS環境で `Secure`, `HttpOnly`, `SameSite=Lax` |
| セッション保存先 | Phase 1: DB、Phase 2以降: Redis（推奨）またはDB |

#### 3.8.4 外部画像URLポリシー

Markdown内で外部URLの画像を参照する場合、閲覧者のIPアドレス等が外部サーバーに送信されるリスクがある（トラッキング）。

| 項目 | 仕様 |
|------|------|
| 既定動作 | **外部画像URLは禁止**（レンダリングしない） |
| 許可方式 | ドメイン許可リスト（管理者が設定） |
| 許可リスト設定 | 管理画面から設定（YAML設定ファイルでも可） |
| 禁止時の表示 | 代替テキスト + 「外部画像は表示できません」メッセージ |
| 将来検討 | サーバー側プロキシ（外部画像をサーバーが取得して配信） |

**理由**:
- 社内ドキュメントで外部画像を許可すると、閲覧者情報が意図せず外部に送信される
- 攻撃者が仕込んだトラッキングピクセルで閲覧行動を監視される可能性
- 許可リスト方式で、信頼できるドメインのみ許可

### 3.9 データ移行

#### 3.9.1 インポート対応（将来）
| ソース | 方式 |
|--------|------|
| Knowledge | DB直接エクスポート（専用ツール作成） |
| Twitter/X | twilog CSV インポート |

---

## 4. 非機能要件

### 4.1 性能
| 項目 | 目標値 |
|------|--------|
| 同時接続ユーザー | 〜50人 |
| 記事数 | 〜100,000件 |
| 検索応答時間 | 2秒以内（権限フィルタ含む） |
| 記事表示 | 1秒以内 |
| 添付アップロード | 50MB/60秒以内 |

### 4.2 可用性
| 項目 | 内容 |
|------|------|
| 運用形態 | オンプレミスサーバー |
| バックアップ | Gitリポジトリ + 添付ディレクトリ + メタDB + OpenSearchスナップショット |
| 復旧手順 | バックアップからのリストア手順を文書化 |

**バックアップの一貫性確保**:

4つの独立したデータストアにまたがるため、バックアップ取得順序と復元手順を定める。

| 項目 | 方針 |
|------|------|
| 一貫性方針 | **ベストエフォート**（完全な時点一貫性は保証しない） |
| 復元後の再同期 | 必須（Git → DB/OpenSearch の整合性を再同期で担保） |
| 推奨取得順序 | 1. アプリケーション停止（推奨）または書き込み一時停止 → 2. メタDB → 3. Gitリポジトリ → 4. 添付ディレクトリ → 5. OpenSearchスナップショット → 6. アプリケーション再開 |
| 停止なしバックアップ | 各ストアを順次バックアップ可（差異は復元時の再同期で吸収） |

**復元時の整合性チェック手順**:
```
1. メタDB を復元
2. Gitリポジトリを復元
3. 添付ディレクトリを復元
4. 整合性チェック実行:
   a. Git上の全記事をスキャンし、DBにACLレコードがない記事を検出
      → デフォルト権限を適用（default_visibility設定に従う）
   b. DBに存在するがGit上にない記事IDのACLレコードを検出
      → 孤立レコードとして管理者に報告（自動削除はしない）
5. OpenSearch を復元（またはスキップ）
6. 全記事の再インデックスを実行（Git → OpenSearch）
7. 整合性チェック結果を管理者に報告
```

### 4.3 セキュリティ
| 項目 | 内容 |
|------|------|
| 通信 | HTTPS必須（本番環境） |
| パスワード | bcrypt でハッシュ化 |
| 監査ログ | Phase 4で実装（誰がいつ何をしたか） |

**監査ログの必須イベント（Phase 4）**:
| 優先度 | イベント |
|--------|----------|
| 最重要 | 権限変更（ACL更新）: 誰が、何を、いつ、どの対象に |
| 最重要 | 緊急遮断（frozen）の設定/解除 |
| 重要 | ログイン/ログアウト |
| 重要 | 記事の作成/削除/復元 |
| 重要 | Gitロールバック実行 |
| 通常 | 記事の編集 |
| 通常 | APIキーの発行/無効化 |
| 通常 | 添付ファイルGC実行 |
| 通常 | oEmbed許可リスト変更 |

**監査ログの保存・運用（Phase 4）**:
| 項目 | 仕様 |
|------|------|
| 保存先 | OpenSearch（検索・分析に適する） |
| 保管期間 | 1年（設定可能） |
| インデックス分割 | 月次（`audit-log-YYYY-MM`） |
| 自動削除 | 保管期間を超えた古いインデックスを自動削除 |
| エクスポート | CSV/JSON形式でのエクスポート機能（管理画面） |

### 4.4 運用・保守
| 項目 | 内容 |
|------|------|
| デプロイ | Docker / Docker Compose 対応 |
| ログ | アプリケーションログ、アクセスログ、エラーログ |
| 監視 | ヘルスチェックエンドポイント（`/health`） |
| 設定 | 環境変数 + 設定ファイル（YAML） |

---

## 5. 技術スタック

### 5.1 バックエンド
| 項目 | 技術 | Phase |
|------|------|-------|
| 言語 | Python 3.11+ | Phase 1〜 |
| Webフレームワーク | FastAPI | Phase 1〜 |
| ORM | SQLAlchemy（ユーザー/権限/メタデータ管理用） | Phase 1〜 |
| Git操作 | gitpython | Phase 1〜 |
| LLM連携 | LiteLLM（複数プロバイダー統一API） | Phase 3〜 |
| LDAP | ldap3 | Phase 4〜 |
| タスクキュー | Celery + Redis（検索インデックス更新等） | Phase 2〜 |

**Phase 1の最小構成**:
- Python + FastAPI + SQLAlchemy + gitpython のみで動作
- Celery / Redis / OpenSearch は不要
- セッション保存は DB（SQLite / PostgreSQL）
- 検索は DB ベースの簡易検索（タイトル・タグの LIKE 検索）

### 5.2 フロントエンド
| 項目 | 技術 | 備考 |
|------|------|------|
| フレームワーク | React 18+ | コンポーネントベース、エコシステム充実 |
| 言語 | TypeScript 5+ | 型安全性、リファクタリング容易性 |
| ビルドツール | Vite | 高速HMR、シンプルな設定 |
| アーキテクチャ | SPA | SEO不要（社内ツール）、UX重視 |
| 状態管理 | Zustand | 軽量、シンプルなAPI |
| APIクライアント | TanStack Query (React Query) | キャッシュ、再取得、楽観的更新 |
| 型生成 | openapi-typescript + openapi-fetch | FastAPI OpenAPIスキーマから自動生成 |
| ルーティング | React Router v6 | 標準的なSPAルーティング |
| Markdownエディタ | @uiw/react-codemirror (CodeMirror 6) | 成熟したReactラッパー |
| Markdownパーサー | markdown-it + プラグイン | 拡張性、GFM対応 |
| Mermaid | mermaid.js | 動的SVGレンダリング【将来対応】 |
| UIコンポーネント | shadcn/ui + Radix UI | アクセシブル、カスタマイズ容易 |
| スタイリング | Tailwind CSS | ユーティリティファースト |
| サニタイザー | DOMPurify | XSS対策 |
| アイコン | Lucide React | 軽量、豊富なアイコンセット |

#### 5.2.1 フロントエンド構成詳細

**プロジェクト構造（案）**
```
frontend/
├── src/
│   ├── api/                  # API クライアント（自動生成型含む）
│   │   ├── generated/        # openapi-typescript 生成ファイル
│   │   └── client.ts         # API クライアント設定
│   ├── components/           # 共通コンポーネント
│   │   ├── ui/               # shadcn/ui コンポーネント
│   │   ├── editor/           # Markdownエディタ関連
│   │   ├── layout/           # レイアウトコンポーネント
│   │   └── wiki/             # Wiki固有コンポーネント
│   ├── features/             # 機能単位のモジュール
│   │   ├── articles/         # 記事管理
│   │   ├── auth/             # 認証
│   │   ├── search/           # 検索
│   │   └── settings/         # 設定
│   ├── hooks/                # カスタムフック
│   ├── stores/               # Zustand ストア
│   ├── lib/                  # ユーティリティ
│   ├── routes/               # ページコンポーネント
│   ├── types/                # 型定義
│   ├── App.tsx
│   └── main.tsx
├── public/
├── index.html
├── vite.config.ts
├── tsconfig.json
├── tailwind.config.js
└── package.json
```

**開発・ビルドフロー**
```
開発時:
  Vite dev server (port 5173) → プロキシ → FastAPI (port 8000)

本番時:
  Vite build → dist/ → Nginx or FastAPI から静的配信
```

**API型同期フロー**
```
FastAPI → /openapi.json → openapi-typescript → src/api/generated/
                                    ↓
                            型安全なAPIクライアント
```

### 5.3 データストア
| 項目 | 技術 | 備考 | Phase |
|------|------|------|-------|
| ドキュメント保存 | ファイルシステム（Git管理） | 記事本文、メタデータYAML | Phase 1〜 |
| 添付保存 | ファイルシステム（Git管理外） | Content-Addressable Storage | Phase 1〜 |
| メタデータDB | SQLite / PostgreSQL（両対応） | SQLAlchemyで抽象化、設定で切替 | Phase 1〜 |
| 検索エンジン | OpenSearch 2.x | 全文検索、ベクトル検索 | Phase 2〜 |
| キャッシュ/キュー | Redis | セッション、タスクキュー | Phase 2〜 |

#### 5.3.1 メタデータDB 使い分け

**推奨構成**:
| 環境 | 推奨DB | 理由 |
|------|--------|------|
| 開発環境 | SQLite | セットアップ不要、単一ファイル |
| 個人利用（1人） | SQLite | シンプル、バックアップ容易 |
| 小規模（〜5人） | SQLite | 同時書き込みが少なければSQLiteで可 |
| 小〜中規模（5〜20人） | **PostgreSQL推奨** | 同時接続の安定性、将来の拡張性 |
| 中規模（20〜50人） | **PostgreSQL必須** | 同時接続、トランザクション性能 |

**選定基準**:
- 同時編集が頻繁に発生する場合 → PostgreSQL
- ACL/APIキー/監査ログの書き込み頻度が高い場合 → PostgreSQL
- 運用の簡素化を最優先（個人・小規模チーム） → SQLite
- 組織利用・将来の拡張を見据える場合 → **PostgreSQL推奨**

**注意**: SQLiteは同時書き込みでロック競合が発生しやすいため、5人以上の組織利用ではPostgreSQLを強く推奨します。

#### 5.3.2 メタデータDBに格納するデータ
| データ | 説明 |
|--------|------|
| ユーザー | ID、名前、メール、パスワードハッシュ、認証方式 |
| グループ | ID、名前、所属ユーザー |
| ロール | ID、名前、権限セット |
| 権限（ACL） | 記事ID × 対象（ユーザー/グループ/ロール） × 権限レベル |
| セッション | セッションID、ユーザーID、有効期限（Phase 2以降はRedisでも可） |
| APIキー | キーハッシュ、ユーザーID、有効期限 |
| システム設定 | LLM設定、oEmbedホワイトリスト、デフォルト公開設定等 |
| 添付ファイル管理 | ハッシュ、MIMEタイプ、サイズ、未参照検出日時（unreferenced_since） |

#### 5.3.3 データの責務分担
```
┌─────────────────────────────────────────────────────────────┐
│                        データ種別と保存先                     │
├─────────────────────────────────────────────────────────────┤
│  Git (ファイルシステム)                                       │
│    - 記事本文 (content.md)                                   │
│    - 記事メタデータ (meta.yaml): タグ、要約、添付参照         │
│    - Wikiメニュー構造 (structure.yaml)                       │
│    - 履歴・差分・ロールバック                                 │
├─────────────────────────────────────────────────────────────┤
│  RDB (SQLite / PostgreSQL)                                  │
│    - ユーザー、グループ（everyoneグループ含む）、ロール       │
│    - 権限 (ACL)                                              │
│    - セッション、APIキー                                     │
│    - システム設定（default_visibility等）                     │
│    - 添付ファイル管理（unreferenced_since等）                │
├─────────────────────────────────────────────────────────────┤
│  OpenSearch（Phase 2以降）                                   │
│    - 検索インデックス（記事本文、メタデータの複製）           │
│    - ベクトル埋め込み                                        │
│    - 監査ログ（Phase 4）                                     │
├─────────────────────────────────────────────────────────────┤
│  Redis（Phase 2以降）                                        │
│    - セッションキャッシュ（RDBと併用可）                      │
│    - タスクキュー（Celery）                                  │
│    - 一時キャッシュ                                          │
├─────────────────────────────────────────────────────────────┤
│  ファイルシステム (Git管理外)                                 │
│    - 添付ファイル本体                                        │
└─────────────────────────────────────────────────────────────┘
```

### 5.4 インフラ
| 項目 | 技術 |
|------|------|
| コンテナ | Docker / Docker Compose |
| リバースプロキシ | Nginx（HTTPS終端、静的ファイル配信） |

---

## 6. 開発フェーズ

### Phase 1: MVP（最小実行可能製品）
**目標**: 基本的な知識管理システムとして動作  
**最小依存**: Python + FastAPI + SQLAlchemy + gitpython（Redis/OpenSearch不要）

- [ ] データモデル実装（記事、メタデータ、添付）
- [ ] ユーザー認証（ローカルアカウント）
- [ ] 基本的な権限管理（ユーザー単位 + everyoneグループ）
- [ ] デフォルト公開設定（default_visibility: open / closed）
- [ ] Markdownエディタ・ビューア
- [ ] 記事のCRUD操作
- [ ] ファイル添付・画像埋め込み
- [ ] Git による差分管理（保存・履歴閲覧・ロールバック）
- [ ] 論理削除・復元
- [ ] Wiki風UI（左メニュー + 右ビュー）
- [ ] タグ管理（手動）
- [ ] 楽観ロック（ETagベースの競合検出・後勝ち警告）
- [ ] 基本的な検索（DBベース: タイトル・タグのLIKE検索）

### Phase 2: 検索強化
**目標**: 高度な検索機能の実装  
**新規依存**: OpenSearch + Celery + Redis

- [ ] OpenSearch 導入
- [ ] BM25 全文検索
- [ ] ベクトル埋め込み（nomic-embed-text）
- [ ] ハイブリッド検索（RRF）
- [ ] 検索インデックス更新キュー（Celery）
- [ ] 検索結果の権限フィルタ（段階的取得方式）
- [ ] 再インデックス機能
- [ ] セッション保存先をRedisに移行（オプション）

### Phase 3: AI機能
**目標**: LLMを活用した支援機能

- [ ] Ollama / llama.cpp 連携（LiteLLM経由）
- [ ] 要約生成機能
- [ ] タグ自動提案
- [ ] RAG Q&A 機能
- [ ] チャンクから記事生成
- [ ] LLM生成メタデータの保存

### Phase 4: エンタープライズ機能
**目標**: 組織利用に必要な機能

- [ ] LDAP連携
- [ ] グループ・ロール管理
- [ ] 詳細なアクセス権限制御（グループ・ロール単位）
- [ ] 「不可視」権限の完全実装
- [ ] REST API（APIキー認証）
- [ ] MCP対応
- [ ] 監査ログ（OpenSearch保存）

### Phase 5: 拡張機能
**目標**: 利便性向上・移行支援

- [ ] クラウドLLM API対応（Claude, OpenAI, etc.）
- [ ] Mermaid対応
- [ ] oEmbed対応（ホワイトリスト管理）
- [ ] 複数記事タブ表示
- [ ] 内部リンク・記事埋め込み記法
- [ ] Knowledge インポートツール
- [ ] twilog CSV インポート
- [ ] PDF エクスポート
- [ ] 物理削除機能（運用設計確立後）
- [ ] SVGサムネイル表示（サーバーサイドPNG変換）

---

## 7. 検討事項・未決定項目

### 7.1 確定済み
| 項目 | 決定内容 |
|------|----------|
| フロントエンドFW | React + TypeScript + Vite（SPA） |
| メタデータDB | SQLite / PostgreSQL 両対応（SQLAlchemyで抽象化） |
| ACLの正（SoT） | DB（meta.yamlには含めない） |
| 物理削除 | v1.0では提供しない（Phase 5以降） |
| SVGファイル | アップロード可、ダウンロードのみ（インライン表示禁止） |
| 認証境界 | UI: Cookieセッション、外部連携: APIキー（JWTは使用しない） |
| 内部リンク記法 | `[[UUID]]` を正式記法、タイトルは入力補助【将来対応】 |
| frozen/noneのAPI応答 | すべて404（存在を示唆しない） |
| 管理者の不可視記事閲覧 | **管理画面のみ**（通常UIでは不可視） |
| Gitロールバック | 記事内容のみ復元、ACLは維持 |
| 添付GC | 未参照判定日から30日猶予、管理者手動実行（v1.0） |
| 添付GC記録方式 | DBに `unreferenced_since` を記録 |
| 監査ログ保存 | OpenSearch、1年保管 |
| 外部画像URL | 既定で禁止、許可リスト方式 |
| oEmbedデフォルト | 既定で無効、管理者が許可設定【将来対応】 |
| Mermaid/oEmbed/内部リンク/タブ | **将来対応（Phase 5）** |
| デフォルト公開設定 | `default_visibility` で open / closed を切替（デフォルト: open） |
| Gitリポジトリ形式 | 通常リポジトリ（non-bare） |
| 楽観ロック方式 | ETagベース（Gitコミットハッシュ） |
| Phase 1最小構成 | Redis/OpenSearch不要、DBベース簡易検索 |
| admin APIキーのACL | バイパスしない（ACLチェック維持） |
| バックアップ一貫性 | ベストエフォート、復元後に再同期 |

### 7.2 将来検討
- リアルタイム共同編集（WebSocket）
- コメント・レビュー機能
- 通知機能（Slack/Teams連携）
- 多言語対応（i18n）
- モバイル対応

---

## 8. 用語定義

| 用語 | 定義 |
|------|------|
| 記事（Article） | Markdown形式で記述された1つのドキュメント |
| チャンク（Chunk） | 小さな単位のメモ。複数を統合して記事を生成する素材 |
| タグ（Tag） | 記事を分類するためのラベル |
| Wiki | 左メニューから記事にアクセスする階層的なビュー |
| 不可視（None） | 記事の存在自体を認識できない権限状態 |
| 緊急遮断（Frozen） | 管理者が即座に記事を非公開化する状態。全ユーザーに不可視 |
| 論理削除 | データは残したまま「削除済み」フラグを立てる削除方式 |
| SoT（Source of Truth） | データの正となる保存先。差異が生じた場合はSoTを優先 |
| everyoneグループ | 全ユーザーが自動的に所属するシステムグループ |

---

## 変更履歴

| 日付 | バージョン | 内容 |
|------|------------|------|
| 2025-06-13 | 0.1.0 | 初版ドラフト作成 |
| 2025-06-13 | 0.2.0 | レビュー指摘反映: データモデル詳細化、権限モデル確定、添付保存方針変更、OpenSearch整合性戦略追加、同時編集戦略追加、セキュリティ要件追加、「不可視」一貫仕様追加 |
| 2025-06-13 | 0.3.0 | フロントエンド技術スタック確定: React + TypeScript + Vite（SPA）、状態管理（Zustand）、APIクライアント（TanStack Query）、型生成（openapi-typescript）、UIコンポーネント（shadcn/ui）|
| 2025-06-13 | 0.4.0 | メタデータDB確定: SQLite / PostgreSQL 両対応（SQLAlchemyで抽象化）、データの責務分担を明確化 |
| 2025-06-14 | 0.5.0 | v1.0スコープ確定: ACLの正をDBに一本化（meta.yamlから削除）、物理削除をv1.0対象外に、SVGはダウンロードのみ許可、認証境界を明確化（UI: Cookie、外部: APIキー）、緊急遮断機能追加、内部リンク記法確定（UUID正式）、検索権限フィルタ上限追加、監査ログイベント定義 |
| 2025-06-14 | 0.6.0 | v1.0スコープ最終版: REST API認証をAPIキーに統一（JWT削除）、frozen/noneのAPI応答を404に統一、添付GC方針追加（30日猶予・手動実行）、検索UX方針追加、Gitロールバック整合性ルール追加、APIキースコープと権限マッピング追加、監査ログ保存先・保管期間追加 |
| 2025-12-14 | 0.6.1 | レビュー指摘対応: (1)v1.0スコープとPhase 5の整合（Mermaid/oEmbed/内部リンク/タブを将来対応に明示）、(2)管理者例外を管理画面のみに限定（通常UIでは不可視統一）、(3)添付GCの記録方式を `unreferenced_since` に確定、(4)DB推奨構成を明確化（5人以上はPostgreSQL推奨）、(5)外部画像URLを既定禁止に、(6)oEmbedを既定無効に |
| 2026-02-23 | 0.7.0 | 開発着手前レビュー対応: (1)meta.yaml `suggested_tags` のYAML構文修正、(2)デフォルト権限を「デフォルト公開」に再設計（everyoneグループ + default_visibility設定）、(3)Phase 1の最小構成を明確化（Redis/OpenSearch不要、DBベース簡易検索）、(4)CAS添付テーブルからfilename削除（meta.yaml側で管理）、(5)Gitリポジトリを通常リポジトリ（non-bare）に変更（選定理由追記）、(6)検索権限フィルタを段階的取得方式に変更（100件ずつ最大500件）、(7)LLMモデル名の例示を実在モデルに修正、(8)admin APIキーのACLバイパスを禁止（セキュリティ強化）、(9)バックアップ一貫性方針・復元時の整合性チェック手順を追加、(10)楽観ロック方式をETagに確定、記事状態遷移の制約理由追記、セッション保存先のPhase別明記、bcrypt記述整理 |
